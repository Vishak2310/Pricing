<!-- START OF FILE Upstep Global V108.44.html -->
<meta name='viewport' content='width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover'/>
<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="color-scheme" content="light">
    <title>Upstep Global - Premium Tool V108.44 (USA/WW Price Fixed)</title>
    <script>
        window.tailwind = {
            config: {
                darkMode: 'class',
                theme: { extend: {} },
                corePlugins: { preflight: true }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <style>
        :root {
            color-scheme: light;
        }
        
        * { font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
    Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

input,
select,
textarea {
  font-size: 16px !important;
  user-select: text !important;
} 
        
        body { 
            min-height: 100vh; 
            position: relative; 
            overflow-x: hidden; 
            background: linear-gradient(180deg, #fdfbf7 0%, #fff7ed 100%) !important; 
            color: #1e3a8a !important; 
            transition: background 0.5s ease;
        }

        .flag-img {
            display: inline-block;
            vertical-align: middle;
            width: 24px;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-right: 8px;
            margin-bottom: 3px;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 16px;
            background: var(--btn-active);
            color: #fff;
            padding: 8px 14px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            z-index: 1000;
            transition: top 0.2s ease;
        }

        .skip-link:focus-visible {
            top: 16px;
            outline: 3px solid rgba(255, 255, 255, 0.8);
            outline-offset: 2px;
        }

        h1, h2, .section-title, .price-final, .region-pill, .premium-brand { font-family: 'Inter', sans-serif; letter-spacing: -0.02em; }
        
        .signature-font, .signature-name { font-family: 'Alex Brush', cursive; }
        .signature-name { font-size: 1.8rem; color: var(--accent); line-height: 1; }

        :root {
            --bg-grad: linear-gradient(180deg, #fdfbf7 0%, #fff7ed 100%);
            --bg-overlay: radial-gradient(circle at 50% 0%, rgba(249, 115, 22, 0.05) 0%, transparent 60%);
            --accent: #f97316; 
            --accent-glow: rgba(249, 115, 22, 0.3);
            
            --text-1: #1e3a8a; 
            --text-2: #64748b;
            
            --header-bg: #ffffff; 
            --header-border: rgba(30, 58, 138, 0.1);
            
            --card-bg: #ffffff; 
            --card-border: #e2e8f0; 
            --card-border-hover: #f97316; 
            --card-shadow: rgba(30, 58, 138, 0.08);
            
            --input-bg: #fff7ed; 
            --input-border: #cbd5e1;
            
            --btn-active: linear-gradient(135deg, #f97316 0%, #ea580c 100%); 
            
            --pill-hover: #fb923c;
            
            --badge-lvl-bg: #fff7ed; 
            --badge-lvl-bd: #fdba74; 
            --badge-lvl-txt: #c2410c;
            
            --scroll-track: #f1f5f9; 
            --scroll-thumb: #94a3b8; 
            --modal-bg: #ffffff;
            
            --logo-sun: #f97316; 
            --logo-piece: #1e3a8a;
            
            --add-save-color: #3b82f6; 
            --ref-save-color: #ec4899; 
            --save-color: #10b981; 

            --prev-bg: linear-gradient(145deg, #fffbeb 0%, #fff7ed 100%);
            --prev-border: rgba(249, 115, 22, 0.3);
            --prev-accent: #f97316;
            --prev-accent-glow: rgba(249, 115, 22, 0.2);
            
            --prev-text-main: #1e3a8a;
            --prev-text-sec: #475569;
            --prev-text-muted: #94a3b8;
            
            --prev-glass-bg: rgba(255, 237, 213, 0.5); 
            --prev-glass-border: rgba(253, 186, 116, 0.3);
            
            --prev-strike: #94a3b8; 
            
            --prev-price-box-bg: rgba(255, 247, 237, 0.6);
            --story-bg: radial-gradient(circle at 50% 50%, #fff7ed 0%, #ffedd5 90%);
            
            --ref-bg: linear-gradient(90deg, #f97316 0%, #fbbf24 100%);
            --ref-txt: #ffffff;
        }

        .strike-slim {
            text-decoration: line-through;
            text-decoration-color: #ef4444; 
            text-decoration-thickness: 1px; 
            color: #475569; 
            font-weight: 700;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0);
            opacity: 0.6;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        .chess-essence { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 80vh; height: 80vh; pointer-events: none; z-index: 0; opacity: 0.03; 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M9 11.5L12 3L15 11.5L19 13V15L17.5 19H6.5L5 15V13L9 11.5Z' stroke='%23f97316' stroke-width='0.5' stroke-linejoin='round'/%3E%3C/svg%3E") !important; 
            background-repeat: no-repeat; background-position: center; transition: background-image 0.5s ease; 
        }
        
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-overlay); pointer-events: none; z-index: 0; }
        
        .premium-header { position: relative; z-index: 100; transition: all 0.3s ease; background: var(--header-bg); border-bottom: 1px solid var(--header-border); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .logo-container { position: relative; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: rgba(0,0,0,0.05); border: 1px solid var(--header-border); overflow: hidden; }
        .sun-rays { animation: spin 20s linear infinite; transform-origin: center; }
        .chess-piece { animation: float 3s ease-in-out infinite; transform-origin: bottom center; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }

        .text-primary { color: var(--text-1); } .text-secondary { color: var(--text-2); } .text-accent { color: var(--accent); }
        .region-nav { backdrop-filter: blur(10px); border-radius: 99px; padding: 6px; transition: all 0.3s ease; background: rgba(125,125,125,0.05); border: 1px solid var(--card-border); display: inline-block; width: auto; min-width: 100%; text-align: center; }
        .region-pill { padding: 8px 18px; border-radius: 99px; font-weight: 700; font-size: 0.9rem; letter-spacing: 0.5px; transition: all 0.3s ease; background: transparent; border: 1px solid transparent; cursor: pointer; color: var(--text-2); text-transform: uppercase; display: inline-flex; align-items: center; }
        .region-pill:hover { color: var(--pill-hover); }
        .region-pill.active { background: var(--btn-active); color: #fff; font-weight: 800; border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); }
        
        .premium-card { border-radius: 12px; padding: 28px; position: relative; box-shadow: 0 20px 50px var(--card-shadow); margin-bottom: 24px; background: var(--card-bg); border: 1px solid var(--card-border); transition: background 0.5s ease, border-color 0.5s ease; }
        .offer-card { border-radius: 16px; padding: 0; position: relative; overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; background: transparent; border: none; }
        .offer-card-content { flex-grow: 1; display: flex; justify-content: center; }
        
        .section-header-btn { display: flex; align-items: center; justify-content: space-between; width: 100%; cursor: pointer; padding: 4px 0; }
        .section-header-btn:hover .section-title, .section-header-btn:hover .icon-chevron { color: var(--accent); }
        .icon-chevron { transition: transform 0.2s ease; }
        .collapsed .icon-chevron { transform: rotate(-90deg); }
        .collapsible-content.hidden { display: none; }
        .premium-card.collapsed { padding-bottom: 20px; }

        .price-final { font-size: 1.8rem; font-weight: 800; background: var(--price-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -1px; }

        .input-premium { border-radius: 6px; padding: 10px 14px; font-weight: 500; transition: all 0.3s ease; width: 100%; background: var(--input-bg); border: 1px solid var(--input-border); color: var(--text-1); }
        .input-premium:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
        .input-premium:disabled { opacity: 0.5; cursor: not-allowed; }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        [tabindex]:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        .tab-container { backdrop-filter: blur(20px); border-radius: 8px; padding: 4px; display: flex; overflow-x: auto; scrollbar-width: none; background: rgba(0,0,0,0.1); border: 1px solid var(--input-border); margin-top: 10px; }
        .tab-btn { padding: 10px 20px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; transition: all 0.3s ease; background: transparent; border: none; cursor: pointer; flex-shrink: 0; margin: 0 2px; white-space: nowrap; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.5px; }
        .tab-btn:hover { color: var(--text-1); }
        .tab-btn.active { background: var(--badge-lvl-bg); color: var(--accent); border: 1px solid var(--badge-lvl-bd); }

        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 0; display: flex; align-items: center; gap: 10px; color: var(--text-1); text-transform: uppercase; letter-spacing: 1px; }
        .section-title::before { content: ''; width: 2px; height: 20px; background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        
        .dropdown-menu {
            position: absolute; 
            z-index: 9999 !important;
            background: white; 
            border: 1px solid var(--card-border); 
            border-radius: 8px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            min-width: 180px; 
            max-height: 250px; 
            overflow-y: auto;
            right: 0; 
            top: 100%;
            margin-top: 5px;
        }
        .dropdown-item { padding: 10px 16px; font-size: 0.8rem; color: var(--text-2); cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 600; text-transform: uppercase; transition: all 0.2s; }
        .dropdown-item:hover { background: var(--badge-lvl-bg); color: var(--accent); }
        .dropdown-item:last-child { border-bottom: none; }
        
        .discount-control { border-radius: 8px; padding: 16px; background: rgba(125,125,125,0.05); border: 1px solid var(--input-border); }
        
        .custom-type-btn { border-radius: 8px; padding: 12px 16px; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--input-border); background: var(--input-bg); display: flex; align-items: center; justify-content: space-between; }
        .custom-type-btn:hover { border-color: var(--accent); }
        .custom-type-btn:has(input:checked) { border-color: var(--accent); background: var(--badge-lvl-bg); color: var(--accent); }
        
        .sub-lvl-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .sub-lvl-btn { border: 1px solid var(--input-border); background: var(--input-bg); border-radius: 99px; padding: 8px 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: all 0.2s ease; min-height: 36px; font-size: 0.75rem; font-weight: 700; }
        .sub-lvl-btn:hover { border-color: var(--text-2); }
        .sub-lvl-btn:has(input:checked) { border-color: var(--accent); background: var(--badge-lvl-bg); color: var(--accent); }
        .sub-lvl-tick { display: none; width: 12px; height: 12px; }
        .sub-lvl-btn:has(input:checked) .sub-lvl-tick { display: block; fill: currentColor; }
        
        .benefit-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: 6px; margin-bottom: 6px; font-size: 0.85rem; background: var(--input-bg); border: 1px solid var(--input-border); }
        .benefit-item-text { flex-grow: 1; margin-right: 8px; color: var(--text-2); }
        .benefit-btn { padding: 4px; border-radius: 4px; background-color: transparent; border: none; cursor: pointer; transition: all 0.2s ease; color: var(--text-2); }
        .benefit-btn:hover { color: var(--text-1); background-color: var(--header-border); }
        .benefit-btn.star.active { color: #f59e0b; }
        .benefit-btn-add { color: var(--save-color); } .benefit-btn-remove { color: #ef4444; }

        .cost-calculator-box { border-radius: 8px; padding: 14px; display: flex; flex-direction: column; gap: 10px; transition: all 0.3s ease; background: var(--input-bg); border: 1px solid var(--input-border); }
        .cost-calc-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-2); }
        .cost-calc-value { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
        .cost-calc-sublabel { font-size: 0.7rem; margin-top: -6px; color: var(--text-2); }

        .lock-btn { padding: 6px 12px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; border: 1px solid; background: transparent; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 5px; border-color: var(--input-border); color: var(--text-2); text-transform: uppercase; letter-spacing: 0.5px; }
        .lock-btn:hover { border-color: var(--accent); color: var(--accent); } .lock-btn.locked { opacity: 0.6; }
        .edit-btn { padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; border: 1px solid; cursor: pointer; transition: all 0.2s ease; margin-left: 8px; border-color: var(--input-border); background: transparent; color: var(--text-2); text-transform: uppercase; }
        .edit-btn:hover { border-color: var(--accent); color: var(--accent); }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; border-radius: 34px; transition: 0.3s; background-color: #4b5563; border: 1px solid #4b5563; opacity: 1; }
        .toggle-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #9ca3af; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        
        .toggle-switch input:checked + .toggle-slider { background: #4b5563; border-color: #4b5563; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); background-color: #10b981; }
        
        .toggle-switch.small { width: 34px; height: 18px; }
        .toggle-switch.small .toggle-slider:before { height: 12px; width: 12px; bottom: 2px; left: 2px; }
        .toggle-switch.small input:checked + .toggle-slider:before { transform: translateX(16px); }

        .class-type-switch { display: flex; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; padding: 4px; position: relative; margin-bottom: 20px; }
        .class-type-label { flex: 1; text-align: center; padding: 10px; z-index: 2; cursor: pointer; font-weight: 700; font-size: 0.8rem; color: var(--text-2); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .class-type-input { display: none; }
        .class-type-input:checked + .class-type-label { color: var(--text-1); }
        .class-type-input:checked + .class-type-label svg.check-icon { display: block; }
        .switch-bg { position: absolute; top: 4px; bottom: 4px; left: 4px; width: calc(50% - 4px); background: var(--btn-active); border-radius: 6px; transition: transform 0.3s ease; z-index: 1; box-shadow: 0 0 10px var(--accent-glow); }
        .class-type-switch:has(input[value="group"]:checked) .switch-bg { transform: translateX(100%); }

        .hidden { display: none !important; }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        .modal { display: none; position: fixed; z-index: 99999; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); backdrop-filter: blur(10px); }
        .modal-content { margin: 10% auto; padding: 0; border: 1px solid var(--input-border); border-radius: 12px; width: 90%; max-width: 500px; background: var(--modal-bg); color: var(--text-1); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--input-border); display: flex; justify-content: space-between; align-items: center; background: rgba(125,125,125,0.05); }
        .close { color: var(--text-2); font-size: 24px; cursor: pointer; transition: color 0.3s; } .close:hover { color: var(--accent); }
        .modal-body { padding: 24px; line-height: 1.6; font-size: 0.9rem; color: var(--text-2); }
        
        .ss-action-btn { padding: 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px; border: 1px solid; width: 100%; }
        .btn-copy-pc { background: var(--input-bg); border-color: var(--accent); color: var(--accent); }
        .btn-copy-pc:hover { background: var(--badge-lvl-bg); box-shadow: 0 0 10px var(--accent-glow); }
        
        #screenshot-preview-modal .modal-content { background: #0f172a; max-width: 90%; width: auto; display: inline-block; text-align: center; }
        #screenshot-preview-image { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }

        /* --- V97: SLIM CARD WITH FIXED ASSETS --- */
        .new-preview-card {
            width: 320px; /* Slim Mobile Width */
            background: var(--prev-bg); 
            border-radius: 18px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--prev-border);
            box-shadow: 0 25px 60px -15px rgba(0,0,0,0.7);
            margin: 0 auto;
            font-family: 'Inter', sans-serif;
        }

        .new-preview-ribbon {
            position: absolute;
            top: 35px;
            right: -60px;
            background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%);
            color: white;
            font-size: 9px;
            font-weight: 800;
            padding: 5px 0;
            width: 200px; 
            text-align: center;
            transform: rotate(45deg);
            z-index: 20;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.2);
            box-sizing: border-box;
        }

        .type-badge {
            background: linear-gradient(180deg, #f59e0b 0%, #b45309 100%);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            font-size: 9px; font-weight: 800; padding: 6px 16px; border-radius: 99px; text-transform: uppercase; letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .type-badge.group {
            background: linear-gradient(180deg, #10b981 0%, #047857 100%);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }

        .stat-glass-tile {
            background: var(--prev-glass-bg);
            border: 1px solid var(--prev-glass-border);
            border-radius: 10px;
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .stat-glass-tile::before {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
            pointer-events: none;
        }

        .new-preview-section-box {
            background: var(--prev-glass-bg);
            border: 1px solid var(--prev-glass-border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .new-preview-price-box {
            background: var(--prev-price-box-bg); 
            border: 1px solid var(--prev-glass-border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .coupon-ticket {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: var(--prev-glass-bg); border: 1px dashed var(--prev-text-sec);
            padding: 8px; border-radius: 6px; margin-bottom: 12px;
        }

        .new-preview-tag-pill {
            font-size: 8px; font-weight: 800; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; background: var(--prev-glass-bg); border: 1px solid var(--prev-glass-border); color: var(--prev-text-sec);
        }

        .new-preview-savings-badge {
            background: #10b981; color: white; padding: 6px 14px; border-radius: 6px; font-size: 11px; font-weight: 800; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }
        
        .referral-glow-badge {
            background: var(--ref-bg);
            color: var(--ref-txt);
            border: none;
            box-shadow: 0 5px 20px var(--prev-accent-glow);
            border-radius: 10px;
            padding: 10px 12px;
            margin-top: 12px;
            text-align: center;
            font-size: 11px;
            font-weight: 800;
            line-height: 1.4;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .referral-glow-badge svg { flex-shrink: 0; width: 16px; height: 16px; stroke-width: 2.5; }
        .referral-glow-badge::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            opacity: 0.3;
            pointer-events: none;
        }

        /* Student Name Controls */
        .student-name-controls { background: rgba(125,125,125,0.05); border: 1px solid var(--input-border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .student-name-input-group { display: flex; gap: 8px; align-items: center; }
        .student-name-toggle { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }

        /* --- FINANCIAL SUITE (WHITE/ORANGE THEME) --- */
        .fs-light-container {
            border-radius: 16px;
            background: linear-gradient(180deg, #ffffff 0%, #fff7ed 100%);
            border: 1px solid var(--card-border);
            box-shadow: 0 20px 40px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            overflow: visible !important; /* Allow dropdowns to pop out */
            color: var(--text-1);
            position: relative;
            z-index: 10;
        }
        /* Ensure dropdowns inside suite don't get clipped */
        .fs-light-container .dropdown-menu { 
            z-index: 9999 !important; 
            background: #ffffff; 
            border: 1px solid var(--card-border); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        .fs-light-container .dropdown-item {
            color: var(--text-2);
        }
        .fs-light-container .dropdown-item:hover {
            background: var(--badge-lvl-bg);
            color: var(--accent);
        }

        .fs-label { font-size: 0.65rem; font-weight: 800; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-2); display: block; margin-bottom: 8px; }
        .fs-input-huge { 
            background: transparent; border: none; font-size: 2.2rem; font-weight: 900; color: var(--text-1); width: 100%; 
            outline: none; padding: 0; line-height: 1; letter-spacing: -1px;
        }
        .fs-input-huge:focus { color: var(--accent); }
        .fs-input-huge:disabled { opacity: 0.7; cursor: not-allowed; color: var(--text-2); }
        .fs-currency { font-size: 1rem; font-weight: 700; color: var(--accent); position: absolute; top: -14px; left: 0; }
        .fs-wrapper { position: relative; padding-top: 10px; }
        
        .fs-btn-lock { 
            width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; background: rgba(0,0,0,0.05); border: 1px solid var(--card-border); 
            color: var(--text-2); cursor: pointer; transition: all 0.2s;
        }
        .fs-btn-lock:hover { color: var(--accent); border-color: var(--accent); background: var(--badge-lvl-bg); }
        .fs-btn-lock.unlocked { color: var(--accent); border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); background: var(--badge-lvl-bg); }

        /* DISCOUNT STACK LIST - LIGHT THEME */
        .ds-container {
            background: rgba(125,125,125,0.03); 
            border-radius: 12px;
            padding: 0;
            overflow: visible; /* FIXED: Dropdown visibility */
            border: 1px solid var(--card-border);
        }
        .ds-row {
            display: grid;
            grid-template-columns: 40px 1fr auto;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--card-border);
            transition: background 0.2s;
            position: relative; /* Context for dropdown */
        }
        .ds-row:hover { background: white; }
        .ds-row:last-child { border-bottom: none; }
        
        .ds-label {
            font-size: 0.75rem;
            font-weight: 800;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .ds-edit-btn {
            font-size: 0.6rem;
            color: var(--text-2);
            cursor: pointer;
            background: transparent;
            border: 1px solid var(--input-border);
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 700;
            display: inline-block;
        }
        .ds-edit-btn:hover { color: var(--accent); border-color: var(--accent); }
        
        .ds-input {
            background: white;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            width: 50px;
            padding: 4px 0;
            outline: none;
            transition: all 0.2s;
            color: var(--text-1);
        }
        .ds-input:focus { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }

        /* VERTICAL TIMELINE BOX - Solves the Overflow Issue */
        .timeline-vertical-box {
            border: 1px solid var(--input-border);
            background: #ffffff;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            transition: all 0.2s;
        }
        .timeline-vertical-box:hover { border-color: var(--accent); box-shadow: 0 5px 15px var(--accent-glow); }
        .timeline-vertical-box:last-child { margin-bottom: 0; }

        .timeline-row-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 8px;
        }
        
        /* Custom Input Styling within Financial Suite (Light Mode) */
        .fs-light-input {
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-1);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.75rem;
            width: 100%;
            transition: all 0.2s;
            font-weight: 600;
        }
        .fs-light-input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 1px var(--accent); }
        .fs-light-input:hover { border-color: var(--text-2); }

        .add-remove-btn {
            width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; transition: all 0.2s; border: 1px solid var(--input-border); background: white;
        }
        .add-remove-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* --- DETAILED TIMELINE PREVIEW STYLES (NEW) --- */
        .roadmap-step {
            display: flex;
            align-items: stretch; /* Stretch to accommodate line */
            margin-bottom: 0; /* Remove default margin to control via gap */
            position: relative;
        }
        
        .roadmap-line-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 12px;
            min-width: 16px;
        }
        
        .roadmap-dot {
            width: 10px; height: 10px; background: var(--prev-accent);
            border-radius: 50%; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
            z-index: 2; margin-top: 14px; /* Align with text */
        }
        
        .roadmap-line {
            flex-grow: 1; width: 2px; background: linear-gradient(180deg, var(--prev-accent) 0%, rgba(249, 115, 22, 0.1) 100%);
            margin-top: 2px; margin-bottom: -6px; /* Connect to next */
        }
        
        .roadmap-step:last-child .roadmap-line {
            background: linear-gradient(180deg, var(--prev-accent) 0%, transparent 100%);
            height: 15px; flex-grow: 0; /* Fade out last line */
        }

        .roadmap-content {
            background: var(--prev-glass-bg);
            border: 1px solid var(--prev-glass-border);
            border-radius: 10px;
            padding: 10px;
            flex-grow: 1;
            margin-bottom: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .roadmap-label { font-size: 11px; font-weight: 800; color: var(--prev-text-main); text-transform: uppercase; letter-spacing: 0.5px; }
        .roadmap-date { font-size: 9px; font-weight: 600; color: var(--prev-text-sec); display: flex; align-items: center; gap: 4px; }
        .roadmap-price { font-size: 18px; font-weight: 900; color: var(--prev-accent); font-family: monospace; letter-spacing: -0.5px; line-height: 1; }
        
        /* UPDATED STRIKETHROUGH STYLE - ULTRA THIN AND CLEAR */
        .strike-small { 
            font-size: 9px; 
            text-decoration: line-through; 
            text-decoration-color: rgba(239, 68, 68, 0.6); /* Semi-transparent red */
            text-decoration-thickness: 0.5px; /* Extremely thin */
            color: #94a3b8; 
            font-weight: 600; 
            margin-right: 4px; 
            opacity: 0.7;
        }
        
        .roadmap-save-badge-static {
            background: #10b981; color: white; padding: 3px 8px; border-radius: 4px;
            font-size: 9px; font-weight: 800; text-transform: uppercase; display: inline-block;
        }

        @media (max-width: 768px) { .premium-card { padding: 20px; } }
    </style>
</head>
<body>
    <div class="chess-essence"></div>
    <a class="skip-link" href="#calculator-container">Skip to calculator</a>

    <header class="premium-header">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between flex-wrap gap-3 relative">
            <div class="flex items-center gap-4">
                <div class="logo-container">
                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none"><g class="sun-rays"><path d="M24 4V8M24 40V44M44 24H40M8 24H4M38.14 9.86L35.31 12.69M12.69 35.31L9.86 38.14M38.14 38.14L35.31 35.31M12.69 12.69L9.86 9.86" stroke="var(--logo-sun)" stroke-width="2" stroke-linecap="round"/></g><circle cx="24" cy="24" r="10" fill="var(--logo-sun)" fill-opacity="0.2"/><path class="chess-piece" d="M24 14C25.1 14 26 14.9 26 16V18H29V21L30 25H18L19 21V18H22V16C22 14.9 22.9 14 24 14ZM18 25H30V27H18V25ZM19 27H29L30 32H18L19 27ZM17 32H31V34H17V32ZM24 18V21" stroke="var(--logo-piece)" stroke-width="1.5" fill="var(--bg-grad)"/></svg>
                </div>
                <div>
                    <h1 class="text-xl font-black text-primary tracking-tight uppercase premium-brand" style="font-family: 'Cinzel', serif;">Upstep Global</h1>
                    <p class="text-[0.65rem] text-accent font-bold tracking-[0.2em] uppercase opacity-80">Premium V108.44</p>
                </div>
            </div>
        </div>
    </header>

    <nav class="py-6 px-4">
        <div class="max-w-7xl mx-auto flex justify-center"><div class="region-nav"><div id="region-nav" class="flex flex-wrap justify-center gap-1"></div></div></div>
    </nav>

    <main id="calculator-container" class="px-4 pb-14 max-w-7xl mx-auto relative z-10" tabindex="-1"></main>
    
    <footer class="text-center py-10 px-4 relative z-10 border-t border-[rgba(125,125,125,0.1)] mt-10">
        <div class="flex flex-col items-center gap-4">
            <div class="text-xs font-semibold text-secondary uppercase tracking-widest">Premium Tools Suite</div>
            <div class="flex items-center gap-2"><span class="text-sm text-primary font-serif italic">Creator</span><span class="signature-name">Suraj Chandra</span></div>
            <button id="credits-btn" onclick="showCredits()" class="mt-2 px-6 py-2 rounded-full border border-[var(--accent)] text-accent font-bold text-[0.65rem] uppercase hover:bg-[var(--accent)] hover:text-white transition tracking-[0.2em]">View Credits</button>
        </div>
    </footer>

    <div id="screenshot-preview-modal" class="modal" style="text-align: center;">
        <div class="modal-content" style="max-width: 400px; margin: 5% auto;">
            <div class="modal-header"><h2 class="text-lg font-bold text-primary uppercase tracking-widest">Offer Preview</h2><span class="close" onclick="closeModal('screenshot-preview-modal')">&times;</span></div>
            <div class="modal-body" style="padding: 20px;"><p class="text-xs text-secondary mb-4">Long-press the image below to <strong>Save</strong> or <strong>Share</strong>.</p><img id="screenshot-preview-image" src="" alt="Offer Screenshot" /></div>
        </div>
    </div>
    <div id="terms-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="text-lg font-bold text-primary uppercase tracking-widest">Terms & Conditions</h2><span class="close" onclick="closeModal('terms-modal')">&times;</span></div><div class="modal-body"><div class="terms-text"><p class="mb-4"><strong>1. Enrollment & Payments:</strong> All fees are non-refundable after the first session. Payments must be made in full prior to commencement.</p><p class="text-xs text-secondary">For full details, contact support@upstepglobal.com.</p></div></div></div></div>
    <div id="credits-modal" class="modal"><div class="modal-content"><div class="modal-header"><h2 class="text-lg font-bold text-primary uppercase tracking-widest">The Story</h2><span class="close" onclick="closeModal('credits-modal')">&times;</span></div><div class="modal-body credits-story"><p class="mb-4">As a Relationship Manager at Upstep Academy, I often found myself fumbling with clunky Excel sheets mid conversation Special thanks to Shubham for testing. This tool is a labor of passion.</p><p class="italic text-accent mt-6 font-serif">With deepest appreciation,</p><p class="signature-name text-3xl mt-2">Suraj Chandra</p></div></div></div>

    <script>
        // --- DISABLE RIGHT CLICK & COPY ---
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && (event.key === 'c' || event.key === 'u' || event.key === 's' || event.key === 'p')) {
                event.preventDefault();
            }
            if(event.key === 'F12') {
                event.preventDefault();
            }
        });

        // --- DATA & CONFIG ---
        const benefitsData = {
            all: ["Certificate endorsed by GM Viswanathan Anand"],
            default: ["Complimentary Saturday practical sessions"],
            group: ["Small interactive batches (3-4 students)", "Peer learning & strategic discussion", "Recorded sessions (20-25 min recaps)", "Cost-effective premium curriculum", "Theme-based mini-tournaments"],
            one_on_one: ["Fully personalized coaching tailored to pace", "Accelerated progress (2-3x faster)", "Flexible scheduling & rescheduling", "Make-up sessions available", "In-depth move analysis"],
            masters: ["Advanced training for professional level", "Calculation skills for 4-10 move foresight", "Target FIDE ratings of 1350-1800", "Strategies from world champions", "Live play with real-time feedback"],
            masters_one_on_one_exclusive: ["Free tournament entry for masters"]
        };
        
        // --- REGIONAL DEFAULT REFERRAL AMOUNTS ---
        const referralDefaults = {
            in: 500,    // India
            uae: 50,    // UAE
            uk: 12,     // UK
            eur: 20,    // Europe
            usa: 14,    // USA
            sgd: 20,    // Singapore
            aus: 20,    // Australia
            can: 20,    // Canada (Approx USD match)
            ww: 14      // Worldwide (USD match)
        };

        const foundationLevels = ['beginner', 'adv_beginner', 'intermediate', 'adv_part_1', 'adv_part_2'];
        const foundationLevelNames = { beginner: 'Beginner', adv_beginner: 'Advanced Beginner', intermediate: 'Intermediate', adv_part_1: 'Advanced Part 1', adv_part_2: 'Advanced Part 2' };
        const mastersLevels = ['sub_junior', 'junior', 'senior_part_1', 'senior_part_2'];
        const mastersLevelNames = { sub_junior: 'Sub-Junior', junior: 'Junior', senior_part_1: 'Senior Part 1', senior_part_2: 'Senior Part 2' };

        const fullLevelSequence = [
            ...foundationLevels.map(key => ({ key, name: foundationLevelNames[key], type: 'foundation' })),
            ...mastersLevels.map(key => ({ key, name: mastersLevelNames[key], type: 'masters' }))
        ];
        
        const regionCodeMap = {
            uae: 'UAE', in: 'IND', uk: 'UK', eur: 'EUR', sgd: 'SIN',
            aus: 'AUS', can: 'CAN', usa: 'USA', ww: 'WW', qat: 'QAT', kwd: 'KWD', sar: 'SAR'
        };

        // FIXED REGION NAMES (Flag IMG Tags properly structured)
        const regionNames = { 
            uae: '<img src="https://flagcdn.com/24x18/ae.png" class="flag-img"> UAE', 
            in: '<img src="https://flagcdn.com/24x18/in.png" class="flag-img"> India', 
            uk: '<img src="https://flagcdn.com/24x18/gb.png" class="flag-img"> UK', 
            eur: '<img src="https://flagcdn.com/24x18/eu.png" class="flag-img"> Europe', 
            sgd: '<img src="https://flagcdn.com/24x18/sg.png" class="flag-img"> Singapore', 
            aus: '<img src="https://flagcdn.com/24x18/au.png" class="flag-img"> Australia', 
            can: '<img src="https://flagcdn.com/24x18/ca.png" class="flag-img"> Canada', 
            usa: '<img src="https://flagcdn.com/24x18/us.png" class="flag-img"> USA', 
            ww: '<img src="https://flagcdn.com/24x18/un.png" class="flag-img"> Worldwide' 
        };
        
        const icons = {
            check: '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>',
            checkCircle: '<svg class="icon-check" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>',
            lock: '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" /></svg>',
            unlock: '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a5 5 0 00-5 5v2a2 2 0 00-2 2v5a2 2 0 002 2h10a2 2 0 002-2v-5a2 2 0 00-2-2H7V7a3 3 0 015.905-.75 1 1 0 001.937-.5A5.002 5.002 0 0010 2z" /></svg>',
            refresh: '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>',
            chevron: '<svg class="w-4 h-4 icon-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>',
            plus: '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>',
            minus: '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 10a.75.75 0 01.75-.75h10.5a.75.75 0 010 1.5H4.75A.75.75 0 014 10z" clip-rule="evenodd" /></svg>',
            star: '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.868 2.884c-.321-.662-1.415-.662-1.736 0l-1.83 3.746-4.132.602c-.728.106-1.018.992-.49 1.503l2.99 2.913-.706 4.117c-.124.726.64 1.28 1.287.933l3.696-1.942 3.696 1.942c.648.46 1.41-.007 1.287-.333l-.706-4.117 2.99-2.913c.528-.51.238-1.396-.49-1.503l-4.132-.602-1.83-3.746z" clip-rule="evenodd" /></svg>'
        };

        const couponTypes = ['LOYALTY', 'UPI DISCOUNT', 'CUSTOM', 'EARLY', 'FESTIVE', 'BUNDLE', 'SPECIAL', 'FLASH', 'SUMMER', 'WINTER', 'WEEKEND', 'WELCOME'];
        const discountLabels = ['Management Discount', 'Sales Head Discount', 'Director Discount', 'VP Discount', 'CEO Special Discount', 'Executive Approval', 'CUSTOM'];
        
        const conversionCurrencies = { 
            'uae': { code: 'AED', symbol: 'AED ', emoji: '<img src="https://flagcdn.com/24x18/ae.png" class="flag-img">', name: 'UAE' }, 
            'in': { code: 'INR', symbol: '₹', emoji: '<img src="https://flagcdn.com/24x18/in.png" class="flag-img">', name: 'India' }, 
            'uk': { code: 'GBP', symbol: '£', emoji: '<img src="https://flagcdn.com/24x18/gb.png" class="flag-img">', name: 'UK' }, 
            'eur': { code: 'EUR', symbol: '€', emoji: '<img src="https://flagcdn.com/24x18/eu.png" class="flag-img">', name: 'Europe' }, 
            'sgd': { code: 'SGD', symbol: 'S$', emoji: '<img src="https://flagcdn.com/24x18/sg.png" class="flag-img">', name: 'Singapore' }, 
            'aus': { code: 'AUD', symbol: 'A$', emoji: '<img src="https://flagcdn.com/24x18/au.png" class="flag-img">', name: 'Australia' }, 
            'can': { code: 'CAD', symbol: 'C$', emoji: '<img src="https://flagcdn.com/24x18/ca.png" class="flag-img">', name: 'Canada' }, 
            'usa': { code: 'USD', symbol: '$', emoji: '<img src="https://flagcdn.com/24x18/us.png" class="flag-img">', name: 'USA' }, 
            'qat': { code: 'QAR', symbol: 'QAR ', emoji: '<img src="https://flagcdn.com/24x18/qa.png" class="flag-img">', name: 'Qatar' }, 
            'kwd': { code: 'KWD', symbol: 'KWD ', emoji: '<img src="https://flagcdn.com/24x18/kw.png" class="flag-img">', name: 'Kuwait' }, 
            'sar': { code: 'SAR', symbol: 'SAR ', emoji: '<img src="https://flagcdn.com/24x18/sa.png" class="flag-img">', name: 'Saudi Arabia' }, 
            'bhd': { code: 'BHD', symbol: 'BHD ', emoji: '<img src="https://flagcdn.com/24x18/bh.png" class="flag-img">', name: 'Bahrain' }, 
            'omr': { code: 'OMR', symbol: 'OMR ', emoji: '<img src="https://flagcdn.com/24x18/om.png" class="flag-img">', name: 'Oman' }, 
            'zaf': { code: 'ZAR', symbol: 'R', emoji: '<img src="https://flagcdn.com/24x18/za.png" class="flag-img">', name: 'South Africa' }, 
            'swe': { code: 'SEK', symbol: 'kr', emoji: '<img src="https://flagcdn.com/24x18/se.png" class="flag-img">', name: 'Sweden' }, 
            'ww': { code: 'USD', symbol: '$', emoji: '<img src="https://flagcdn.com/24x18/un.png" class="flag-img">', name: 'Worldwide' } 
        };
        
        // --- AUDITED PRICING DATA (V108.44) ---
        // PERFECTLY MATCHED TO THE SCREENSHOTS
        const allPrices = { 
            uae: { 
                currency: 'AED', 
                foundation: { 
                    one_on_one: { beginner: 1220, adv_beginner: 1220, intermediate: 1310, adv_part_1: 1475, adv_part_2: 1475 }, 
                    group: { beginner: 815, adv_beginner: 815, intermediate: 875, adv_part_1: 995, adv_part_2: 995 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 8400, price_48: 4200 }, junior: { price_96: 8600, price_48: 4300 }, senior_part_1: { price_96: 9100, price_48: 4550 }, senior_part_2: { price_96: 9100, price_48: 4550 } }, 
                    group: { sub_junior: { price_96: 4700, price_48: 2350 }, junior: { price_96: 4900, price_48: 2450 }, senior_part_1: { price_96: 5200, price_48: 2600 }, senior_part_2: { price_96: 5200, price_48: 2600 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            in: { 
                currency: '₹', 
                foundation: { 
                    one_on_one: { beginner: 23850, adv_beginner: 23850, intermediate: 26880, adv_part_1: 33500, adv_part_2: 33500 }, 
                    regular_group: { beginner: 7650, adv_beginner: 7650, intermediate: 8200, adv_part_1: 8850, adv_part_2: 8850 }, 
                    focused_group: { beginner: 15300, adv_beginner: 15300, intermediate: 16400, adv_part_1: 17700, adv_part_2: 17700 },
                    groupName: 'Regular Group (Max 8 Kids)', 
                    groupName2: 'Focused Group (Max 4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 174800, price_48: 87400 }, junior: { price_96: 180800, price_48: 90400 }, senior_part_1: { price_96: 190600, price_48: 95300 }, senior_part_2: { price_96: 190600, price_48: 95300 } }, 
                    group: { sub_junior: { price_96: 47900, price_48: 23950 }, junior: { price_96: 51200, price_48: 25600 }, senior_part_1: { price_96: 55000, price_48: 27500 }, senior_part_2: { price_96: 55000, price_48: 27500 } }, 
                    groupName: 'PTP Group (Max 4 Kids)' 
                } 
            }, 
            uk: { 
                currency: '£', 
                foundation: { 
                    one_on_one: { beginner: 305, adv_beginner: 305, intermediate: 335, adv_part_1: 380, adv_part_2: 380 }, 
                    group: { beginner: 210, adv_beginner: 210, intermediate: 235, adv_part_1: 270, adv_part_2: 270 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 2210, price_48: 1105 }, junior: { price_96: 2290, price_48: 1145 }, senior_part_1: { price_96: 2420, price_48: 1210 }, senior_part_2: { price_96: 2420, price_48: 1210 } }, 
                    group: { sub_junior: { price_96: 1320, price_48: 660 }, junior: { price_96: 1380, price_48: 690 }, senior_part_1: { price_96: 1460, price_48: 730 }, senior_part_2: { price_96: 1460, price_48: 730 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            eur: { 
                currency: '€', 
                foundation: { 
                    one_on_one: { beginner: 373, adv_beginner: 373, intermediate: 408, adv_part_1: 459, adv_part_2: 459 }, 
                    group: { beginner: 250, adv_beginner: 250, intermediate: 281, adv_part_1: 322, adv_part_2: 322 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 2660, price_48: 1330 }, junior: { price_96: 2760, price_48: 1380 }, senior_part_1: { price_96: 2920, price_48: 1460 }, senior_part_2: { price_96: 2920, price_48: 1460 } }, 
                    group: { sub_junior: { price_96: 1590, price_48: 795 }, junior: { price_96: 1660, price_48: 830 }, senior_part_1: { price_96: 1760, price_48: 880 }, senior_part_2: { price_96: 1760, price_48: 880 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            sgd: { 
                currency: 'S$', 
                foundation: { 
                    one_on_one: { beginner: 465, adv_beginner: 465, intermediate: 499, adv_part_1: 545, adv_part_2: 545 }, 
                    group: { beginner: 305, adv_beginner: 305, intermediate: 330, adv_part_1: 375, adv_part_2: 375 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 3000, price_48: 1500 }, junior: { price_96: 3100, price_48: 1550 }, senior_part_1: { price_96: 3250, price_48: 1625 }, senior_part_2: { price_96: 3250, price_48: 1625 } }, 
                    group: { sub_junior: { price_96: 1730, price_48: 865 }, junior: { price_96: 1810, price_48: 905 }, senior_part_1: { price_96: 1920, price_48: 960 }, senior_part_2: { price_96: 1920, price_48: 960 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            aus: { 
                currency: 'A$', 
                foundation: { 
                    one_on_one: { beginner: 465, adv_beginner: 465, intermediate: 505, adv_part_1: 545, adv_part_2: 545 }, 
                    group: { beginner: 305, adv_beginner: 305, intermediate: 335, adv_part_1: 380, adv_part_2: 380 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 3300, price_48: 1650 }, junior: { price_96: 3420, price_48: 1710 }, senior_part_1: { price_96: 3600, price_48: 1800 }, senior_part_2: { price_96: 3600, price_48: 1800 } }, 
                    group: { sub_junior: { price_96: 1820, price_48: 910 }, junior: { price_96: 1910, price_48: 955 }, senior_part_1: { price_96: 2030, price_48: 1015 }, senior_part_2: { price_96: 2030, price_48: 1015 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            can: { 
                currency: 'C$', 
                foundation: { 
                    one_on_one: { beginner: 602, adv_beginner: 602, intermediate: 658, adv_part_1: 709, adv_part_2: 709 }, 
                    group: { beginner: 373, adv_beginner: 373, intermediate: 408, adv_part_1: 460, adv_part_2: 460 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    one_on_one: { sub_junior: { price_96: 4260, price_48: 2130 }, junior: { price_96: 4420, price_48: 2210 }, senior_part_1: { price_96: 4650, price_48: 2325 }, senior_part_2: { price_96: 4650, price_48: 2325 } }, 
                    group: { sub_junior: { price_96: 2480, price_48: 1240 }, junior: { price_96: 2600, price_48: 1300 }, senior_part_1: { price_96: 2750, price_48: 1375 }, senior_part_2: { price_96: 2750, price_48: 1375 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            usa: { 
                currency: '$', 
                foundation: { 
                    one_on_one: { beginner: 418, adv_beginner: 418, intermediate: 460, adv_part_1: 495, adv_part_2: 495 }, 
                    group: { beginner: 260, adv_beginner: 260, intermediate: 285, adv_part_1: 320, adv_part_2: 320 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    // FIXED PRICES AS PER USA PDF PAGE 178 (1-on-1)
                    one_on_one: { sub_junior: { price_96: 2970, price_48: 1485 }, junior: { price_96: 3080, price_48: 1540 }, senior_part_1: { price_96: 3240, price_48: 1620 }, senior_part_2: { price_96: 3240, price_48: 1620 } }, 
                    // FIXED PRICES AS PER USA PDF PAGE 179 (Group)
                    group: { sub_junior: { price_96: 1730, price_48: 865 }, junior: { price_96: 1810, price_48: 905 }, senior_part_1: { price_96: 1920, price_48: 960 }, senior_part_2: { price_96: 1920, price_48: 960 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            }, 
            ww: { 
                currency: '$', 
                foundation: { 
                    one_on_one: { beginner: 418, adv_beginner: 418, intermediate: 460, adv_part_1: 495, adv_part_2: 495 }, 
                    group: { beginner: 260, adv_beginner: 260, intermediate: 285, adv_part_1: 320, adv_part_2: 320 }, 
                    groupName: 'Focused Group (4 Kids)' 
                }, 
                masters: { 
                    // FIXED PRICES AS PER WW PDF PAGE 134 (1-on-1)
                    one_on_one: { sub_junior: { price_96: 2990, price_48: 1495 }, junior: { price_96: 3100, price_48: 1550 }, senior_part_1: { price_96: 3260, price_48: 1630 }, senior_part_2: { price_96: 3260, price_48: 1630 } }, 
                    // FIXED PRICES AS PER WW PDF PAGE 135 (Group)
                    group: { sub_junior: { price_96: 1750, price_48: 875 }, junior: { price_96: 1830, price_48: 915 }, senior_part_1: { price_96: 1940, price_48: 970 }, senior_part_2: { price_96: 1940, price_48: 970 } }, 
                    groupName: 'BTP Group (3-4 Kids)' 
                } 
            } 
        };
        const classStructure = { foundation_group: { total: 24, duration: 3, duration_unit: 'Months', sub1: 8, sub2: 8, sub3: 8, count: 3 }, foundation_regular_group: { total: 24, duration: 3, duration_unit: 'Months', sub1: 8, sub2: 8, sub3: 8, count: 3 }, foundation_focused_group: { total: 24, duration: 3, duration_unit: 'Months', sub1: 8, sub2: 8, sub3: 8, count: 3 }, foundation_one_on_one: { total: 20, duration: 2.5, duration_unit: 'Months', sub1: 6, sub2: 6, sub3: 8, count: 3 }, masters_group: { total: 96, duration: 12, duration_unit: 'Months', sub1: 16, sub2: 16, sub3: 16, sub4: 16, sub5: 16, sub6: 16, count: 6, partial_total: 48, partial_duration: 6, partial_subs: 3 }, masters_one_on_one: { total: 96, duration: 12, duration_unit: 'Months', sub1: 16, sub2: 16, sub3: 16, sub4: 16, sub5: 16, sub6: 16, count: 6, partial_total: 48, partial_duration: 6, partial_subs: 3 } };
        
        const globalLevelSequence = [ 
            { code: 'B1', levelKey: 'beginner', subIndex: 1, name: 'Beginner 1' }, { code: 'B2', levelKey: 'beginner', subIndex: 2, name: 'Beginner 2' }, { code: 'B3', levelKey: 'beginner', subIndex: 3, name: 'Beginner 3' }, 
            { code: 'AB1', levelKey: 'adv_beginner', subIndex: 1, name: 'Adv. Beginner 1' }, { code: 'AB2', levelKey: 'adv_beginner', subIndex: 2, name: 'Adv. Beginner 2' }, { code: 'AB3', levelKey: 'adv_beginner', subIndex: 3, name: 'Adv. Beginner 3' }, 
            { code: 'I1', levelKey: 'intermediate', subIndex: 1, name: 'Intermediate 1' }, { code: 'I2', levelKey: 'intermediate', subIndex: 2, name: 'Intermediate 2' }, { code: 'I3', levelKey: 'intermediate', subIndex: 3, name: 'Intermediate 3' }, 
            { code: 'A1', levelKey: 'adv_part_1', subIndex: 1, name: 'Advanced 1' }, { code: 'A2', levelKey: 'adv_part_1', subIndex: 2, name: 'Advanced 2' }, { code: 'A3', levelKey: 'adv_part_1', subIndex: 3, name: 'Advanced 3' }, 
            { code: 'A4', levelKey: 'adv_part_2', subIndex: 1, name: 'Advanced 4' }, { code: 'A5', levelKey: 'adv_part_2', subIndex: 2, name: 'Advanced 5' }, { code: 'A6', levelKey: 'adv_part_2', subIndex: 3, name: 'Advanced 6' }, 
            { code: 'SJR1', levelKey: 'sub_junior', subIndex: 1, name: 'Sub-Junior 1' }, { code: 'SJR2', levelKey: 'sub_junior', subIndex: 2, name: 'Sub-Junior 2' }, { code: 'SJR3', levelKey: 'sub_junior', subIndex: 3, name: 'Sub-Junior 3' }, { code: 'SJR4', levelKey: 'sub_junior', subIndex: 4, name: 'Sub-Junior 4' }, { code: 'SJR5', levelKey: 'sub_junior', subIndex: 5, name: 'Sub-Junior 5' }, { code: 'SJR6', levelKey: 'sub_junior', subIndex: 6, name: 'Sub-Junior 6' }, 
            { code: 'JR1', levelKey: 'junior', subIndex: 1, name: 'Junior 1' }, { code: 'JR2', levelKey: 'junior', subIndex: 2, name: 'Junior 2' }, { code: 'JR3', levelKey: 'junior', subIndex: 3, name: 'Junior 3' }, { code: 'JR4', levelKey: 'junior', subIndex: 4, name: 'Junior 4' }, { code: 'JR5', levelKey: 'junior', subIndex: 5, name: 'Junior 5' }, { code: 'JR6', levelKey: 'junior', subIndex: 6, name: 'Junior 6' },
            { code: 'SR1', levelKey: 'senior_part_1', subIndex: 1, name: 'Senior 1' }, { code: 'SR2', levelKey: 'senior_part_1', subIndex: 2, name: 'Senior 2' }, { code: 'SR3', levelKey: 'senior_part_1', subIndex: 3, name: 'Senior 3' }, { code: 'SR4', levelKey: 'senior_part_1', subIndex: 4, name: 'Senior 4' }, { code: 'SR5', levelKey: 'senior_part_1', subIndex: 5, name: 'Senior 5' }, { code: 'SR6', levelKey: 'senior_part_1', subIndex: 6, name: 'Senior 6' },
            { code: 'SR7', levelKey: 'senior_part_2', subIndex: 1, name: 'Senior 7' }, { code: 'SR8', levelKey: 'senior_part_2', subIndex: 2, name: 'Senior 8' }, { code: 'SR9', levelKey: 'senior_part_2', subIndex: 3, name: 'Senior 9' }, { code: 'SR10', levelKey: 'senior_part_2', subIndex: 4, name: 'Senior 10' }, { code: 'SR11', levelKey: 'senior_part_2', subIndex: 5, name: 'Senior 11' }, { code: 'SR12', levelKey: 'senior_part_2', subIndex: 6, name: 'Senior 12' }
        ];

        let appState = {}; 
        let currentActiveTab = 'full';
        let currentRegion = 'uae';
        let globalConversionRates = null;
        let globalConversionTimestamp = null;
        
        let apGlobalState = {
            rawInput: '', targetRegion: 'uae', classType: 'one_on_one', bundleMode: '3', customCount: 1, isParsed: false, detectedLevelIndex: -1, customerName: 'Student',
            oppMode: 'parent', 
            referralAmount: '',
            referralEnabled: false 
        };

        const StudentNameController = {
            init: function(region, tabType) {
                const rs = getRegionState(region);
                if (!rs.studentName) {
                    rs.studentName = { 
                        full: { name: 'Johnathan Doe', show: false }, 
                        foundation: { name: 'Johnathan Doe', show: false }, 
                        masters: { name: 'Johnathan Doe', show: false }, 
                        autoPricer: { name: apGlobalState.customerName, show: false } 
                    };
                }
            },
            getStudentName: function(region, tabType) { const rs = getRegionState(region); return rs.studentName?.[tabType]?.name || 'Johnathan Doe'; },
            setStudentName: function(region, tabType, name) { const rs = getRegionState(region); if(!rs.studentName) rs.studentName={}; if(!rs.studentName[tabType]) rs.studentName[tabType]={name:'Johnathan Doe',show:false}; rs.studentName[tabType].name=name; if(tabType==='full') recalcFullOffers(region); else if(tabType==='foundation'||tabType==='masters') calculateCustomPackage(region,tabType); else if(tabType==='autoPricer') updateAPState('rawInput',apGlobalState.rawInput); },
            getShowStudentName: function(region, tabType) { const rs = getRegionState(region); return rs.studentName?.[tabType]?.show ?? false; },
            setShowStudentName: function(region, tabType, show) { const rs = getRegionState(region); if(!rs.studentName) rs.studentName={}; if(!rs.studentName[tabType]) rs.studentName[tabType]={name:'Johnathan Doe',show:false}; rs.studentName[tabType].show=show; if(tabType==='full') recalcFullOffers(region); else if(tabType==='foundation'||tabType==='masters') calculateCustomPackage(region,tabType); else if(tabType==='autoPricer') updateAPState('rawInput',apGlobalState.rawInput); },
            renderControls: function(region, tabType) {
                const name = this.getStudentName(region, tabType); const show = this.getShowStudentName(region, tabType);
                return `<div class="student-name-controls"><div class="student-name-toggle"><label class="flex items-center gap-2 cursor-pointer"><label class="toggle-switch"><input type="checkbox" id="student-name-toggle-${tabType}-${region}" ${show ? 'checked' : ''} onchange="StudentNameController.setShowStudentName('${region}', '${tabType}', this.checked)"><span class="toggle-slider"></span></label><span class="text-xs font-bold text-accent uppercase">Show Student Name</span></label></div><div class="student-name-input-group"><input type="text" id="student-name-input-${tabType}-${region}" value="${name}" oninput="StudentNameController.setStudentName('${region}', '${tabType}', this.value)" class="input-premium flex-grow" placeholder="Enter student name"></div></div>`;
            }
        };

        function generateNewPreviewHTML(options) {
            const { region, idPrefix, studentName, showStudentName, classType, levels = [], totalSessions = 0, totalMonths = 0, benefits = [], priceDetails = {}, currency = '$', couponCode = '', expiry = '', title = '', levelCount = 0, bannerSettings = { showBanner: false, bannerText: '' }, showDiscountPercent = false, priceLabelType = 'TOTAL INVESTMENT', showPPC = false, conversion = { enabled: false, targetCurrency: '', rate: 1, symbol: '' }, referralSettings = { show: true, amount: '' }, roadmapSettings = { show: false, rows: [] } } = options;

            const isOneOnOne = classType.includes('one_on_one');
            const typeText = isOneOnOne ? '1-ON-1 MASTERY' : 'INTENSIVE GROUP';
            const typeClass = isOneOnOne ? 'type-badge' : 'type-badge group';
            
            let finalCurrency = currency;
            let displayFullPrice = priceDetails.fullPrice;
            let displayFinalPrice = priceDetails.finalPrice;
            let displaySavings = displayFullPrice - displayFinalPrice;
            let displayNormalSave = priceDetails.discounts.normalValue || 0;
            let displayMgmtSave = priceDetails.discounts.mgmtValue || 0;
            
            let displayRefSave = priceDetails.discounts.referralValue || 0;
            let ppcValue = totalSessions > 0 ? displayFinalPrice / totalSessions : 0;
            
            let originalFinalPrice = priceDetails.finalPrice;
            let originalCurrency = allPrices[region].currency;

            if (conversion && conversion.enabled && conversion.rate && conversion.targetCurrency !== allPrices[region].currency) {
                finalCurrency = conversion.symbol;
                displayFullPrice *= conversion.rate; displayFinalPrice *= conversion.rate; displaySavings *= conversion.rate;
                displayNormalSave *= conversion.rate; displayMgmtSave *= conversion.rate; displayRefSave *= conversion.rate;
                ppcValue *= conversion.rate;
            }

            const formatCurrency = (value) => `${finalCurrency}${Math.floor(Math.abs(value)).toLocaleString(finalCurrency === ' ' ? 'en-IN' : undefined)}`;
            const formatCurrencyDecimal = (value) => `${finalCurrency}${Math.abs(value).toLocaleString(finalCurrency === ' ' ? 'en-IN' : undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const formatOriginal = (value) => `${originalCurrency}${Math.floor(Math.abs(value)).toLocaleString(originalCurrency === ' ' ? 'en-IN' : undefined)}`;
            
            let levelRowsHTML = '';
            if (levels.length > 0) {
                levels.forEach(level => { 
                    levelRowsHTML += `
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; border-bottom:1px dashed rgba(249,115,22,0.1); padding-bottom:4px; last:border-bottom:none;">
                            <div style="font-size:13px; font-weight:700; color:var(--prev-text-main);">${level.name}</div>
                            <span class="new-preview-tag-pill" style="font-size:8px;">${level.subLevels}</span>
                        </div>`; 
                });
            } else { levelRowsHTML = '<div class="text-center text-black/30 italic py-4 text-[10px]">No levels selected</div>'; }
            
            let benefitsHTML = '';
            if (benefits.length > 0) {
                benefitsHTML += `<div style="display:flex; flex-direction:column; gap:4px;">`;
                benefits.forEach(benefit => { benefitsHTML += `<div style="display:flex; align-items:start; gap:6px;"><svg class="w-3 h-3 mt-0.5 flex-shrink-0" style="color:var(--prev-accent);" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span style="font-size:10px; color:var(--prev-text-sec); font-weight:500; line-height:1.4;">${benefit}</span></div>`; });
                benefitsHTML += `</div>`;
            }
            
            let discountRowsHTML = '';
            const discounts = priceDetails.discounts;
            const pStr = (val) => showDiscountPercent ? ` <span style="color:var(--prev-accent); font-size:11px; font-weight:800;">(${Number(val).toFixed(0)}%)</span>` : '';

            if (discounts.normal > 0) discountRowsHTML += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;"><span style="font-size:11px; color:#34d399; font-weight:600;">Coupon Discount${pStr(discounts.normal)}</span><span style="font-size:11px; font-family:monospace; color:#34d399; font-weight:700;">- ${formatCurrency(displayNormalSave)}</span></div>`;
            if (discounts.mgmt > 0) discountRowsHTML += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;"><span style="font-size:11px; color:var(--prev-accent); font-weight:600;">Management Approval${pStr(discounts.mgmt)}</span><span style="font-size:11px; font-family:monospace; color:var(--prev-accent); font-weight:700;">- ${formatCurrency(displayMgmtSave)}</span></div>`;
            if (displayRefSave > 0) discountRowsHTML += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;"><span style="font-size:11px; color:#f472b6; font-weight:600;">Referral Bonus</span><span style="font-size:11px; font-family:monospace; color:#f472b6; font-weight:700;">- ${formatCurrency(displayRefSave)}</span></div>`;
            
            let bannerHTML = (bannerSettings.showBanner && bannerSettings.bannerText) ? `<div class="new-preview-ribbon">${bannerSettings.bannerText}</div>` : '';
            const tcHtml = `<div style="margin-top:10px; font-size:8px; color:var(--prev-text-muted); font-weight:600; text-transform:uppercase; letter-spacing:1px; text-align:center;">* T&C APPLIED</div>`;

            const uniqueId = idPrefix + '-' + Math.floor(Math.random() * 100000);
            const gradS = `gradS-${uniqueId}`;
            const gradD = `gradD-${uniqueId}`;

            const sessGradStart = '#f97316'; 
            const sessGradEnd = '#c2410c'; 
            const durGradStart = '#60a5fa'; 
            const durGradEnd = '#1e3a8a'; 

            const iconSessions = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><defs><linearGradient id="${gradS}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:${sessGradStart};stop-opacity:1" /><stop offset="100%" style="stop-color:${sessGradEnd};stop-opacity:1" /></linearGradient></defs><path d="M12 3L1 9L12 15L21 9V17H23V9L12 3Z M5 13.18V17.18L12 21L19 17.18V13.18L12 17L5 13.18Z" stroke="url(#${gradS})" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const iconDuration = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none"><defs><linearGradient id="${gradD}" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:${durGradStart};stop-opacity:1" /><stop offset="100%" style="stop-color:${durGradEnd};stop-opacity:1" /></linearGradient></defs><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke="url(#${gradD})" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

            let referralHTML = '';
            if (referralSettings && referralSettings.show) {
                const referralText = referralSettings.amount && referralSettings.amount.toString().trim() !== '' 
                    ? `Refer & Earn ${referralSettings.amount} off*` 
                    : `Refer friends & get Rewards*`;
                
                referralHTML = `
                    <div class="referral-glow-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                        <span>${referralText}</span>
                    </div>
                `;
            }

            let timelinePreviewHTML = '';
            let showTimeline = false;
            
            if(roadmapSettings && roadmapSettings.show && roadmapSettings.rows && roadmapSettings.rows.some(r => r.label || r.date || r.percent > 0)) {
                showTimeline = true;
                let stepsHTML = '';
                
                roadmapSettings.rows.forEach(row => {
                    if(row.label || row.date || row.percent > 0) {
                        const tierSave = displayFullPrice * (row.percent / 100);
                        let tierPrice = displayFullPrice - tierSave - displayMgmtSave - displayRefSave;
                        if(tierPrice < 0) tierPrice = 0;
                        
                        const totalSave = displayFullPrice - tierPrice;

                        stepsHTML += `
                            <div class="roadmap-step">
                                <div class="roadmap-line-container">
                                    <div class="roadmap-dot"></div>
                                    <div class="roadmap-line"></div>
                                </div>
                                <div class="roadmap-content">
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div class="roadmap-label">${row.label || 'Tier'}</div>
                                        <div class="roadmap-price">${formatCurrency(tierPrice)}</div>
                                    </div>
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <div class="roadmap-date">
                                            <svg style="width:8px; height:8px;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                            ${row.date || 'No Expiry'}
                                        </div>
                                        <div style="display:flex; align-items:center; gap:6px;">
                                            ${totalSave > 0 ? `<span class="strike-small">${formatCurrency(displayFullPrice)}</span>` : ''}
                                            ${totalSave > 0 ? `<div class="roadmap-save-badge-static">Save ${formatCurrency(totalSave)}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                timelinePreviewHTML = `
                    <div style="margin-top:10px; margin-bottom:16px;">
                        <div style="text-align:center; margin-bottom:16px; padding:12px; background:var(--prev-glass-bg); border:1px solid var(--prev-glass-border); border-radius:12px;">
                            <div style="font-size:9px; text-transform:uppercase; font-weight:800; color:var(--prev-text-sec); letter-spacing:1px; margin-bottom:4px;">${priceLabelType}</div>
                            <div style="font-size:32px; font-weight:900; color:var(--prev-text-main); line-height:1; letter-spacing:-1px; text-shadow:0 0 25px var(--prev-accent-glow);">${formatCurrency(displayFullPrice)}</div>
                            ${conversion && conversion.enabled ? `<div style="font-size:9px; color:var(--prev-text-muted); font-weight:600;">(approx. ${formatOriginal(priceDetails.fullPrice)})</div>` : ''}
                        </div>
                        
                        <div style="padding-left:4px;">
                            ${stepsHTML}
                        </div>
                    </div>
                `;
            }

            const hasDiscounts = displayFullPrice > displayFinalPrice;
            const hasCoupon = couponCode !== '';
            const showTopSection = hasDiscounts || hasCoupon;

            return `
                <div class="new-preview-card" data-card-id="${idPrefix}">
                    ${bannerHTML}
                    <div style="position:relative; z-index:10; padding:20px;">
                        
                        <div style="text-align:center; margin-bottom:20px; margin-top:24px;">
                            ${showStudentName ? `
                                <div style="font-size:9px; color:var(--prev-accent); letter-spacing:3px; text-transform:uppercase; font-weight:800; margin-bottom:6px; opacity:0.8;">Prepared For</div>
                                <h1 style="font-size:24px; color:var(--prev-text-main); font-family:'Playfair Display', serif; font-weight:700; line-height:1.2; letter-spacing:-0.5px;">${studentName}</h1>
                            ` : `
                                <div style="font-size:9px; color:var(--prev-accent); letter-spacing:3px; text-transform:uppercase; font-weight:800; margin-bottom:6px; opacity:0.8;">Curriculum Name</div>
                                <h1 style="font-size:20px; color:var(--prev-text-main); font-family:'Playfair Display', serif; font-weight:700; line-height:1.2;">${title || 'Custom Package'}</h1>
                            `}
                            <div style="display:flex; justify-content:center; gap:8px; margin-top:10px;">
                                <div class="${typeClass}">${typeText}</div>
                            </div>
                        </div>

                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                            <div class="stat-glass-tile">
                                <div style="margin-bottom:4px;">${iconSessions}</div>
                                <div style="font-size:8px; text-transform:uppercase; color:var(--prev-text-sec); font-weight:700; letter-spacing:1px;">Sessions</div>
                                <div style="font-size:16px; color:var(--prev-text-main); font-weight:800;">${totalSessions}</div>
                            </div>
                            <div class="stat-glass-tile">
                                <div style="margin-bottom:4px;">${iconDuration}</div>
                                <div style="font-size:8px; text-transform:uppercase; color:var(--prev-text-sec); font-weight:700; letter-spacing:1px;">Duration</div>
                                <div style="font-size:16px; color:var(--prev-text-main); font-weight:800;">~${totalMonths} Mo.</div>
                            </div>
                        </div>
                        
                        <div class="new-preview-section-box">
                            <div style="font-size:9px; text-transform:uppercase; font-weight:800; color:var(--prev-text-sec); letter-spacing:1px; margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid var(--prev-glass-border);">
                                Curriculum
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px;">${levelRowsHTML}</div>
                        </div>
                        
                        ${benefitsHTML ? `
                            <div class="new-preview-section-box" style="background:transparent; border:none; padding:4px 0 10px 0;">
                                <div style="font-size:9px; text-transform:uppercase; font-weight:800; color:var(--prev-text-sec); letter-spacing:1px; margin-bottom:6px;">Student Privileges</div>
                                ${benefitsHTML}
                            </div>
                        ` : ''}

                        ${showTimeline ? timelinePreviewHTML : `
                            <div class="new-preview-price-box">
                                ${showTopSection ? `
                                    <div style="margin-bottom:12px;">
                                        ${displayFullPrice > displayFinalPrice ? `
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                            <span style="font-size:11px; color:var(--prev-text-sec); font-weight:700; text-transform:uppercase;">Standard Fee</span>
                                            <span class="strike-slim" style="font-family:monospace; font-size:14px;">${formatCurrency(displayFullPrice)}</span>
                                        </div>
                                        ` : ''}
                                        ${discountRowsHTML}
                                    </div>

                                    ${couponCode ? `
                                        <div class="coupon-ticket">
                                            <div style="font-size:9px; color:var(--prev-text-sec); font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-bottom:2px;">Voucher Applied</div>
                                            <div style="font-size:14px; color:var(--prev-accent); font-family:monospace; font-weight:800; letter-spacing:1px;">${couponCode}</div>
                                        </div>
                                    ` : ''}

                                    <div style="height:1px; background:var(--prev-glass-border); width:100%; margin-bottom:14px;"></div>
                                ` : ''}

                                <div style="display:flex; flex-direction:column; align-items:center; gap:4px;">
                                    <div style="font-size:9px; text-transform:uppercase; font-weight:800; color:var(--prev-text-sec); letter-spacing:1px;">${priceLabelType}</div>
                                    <div style="font-size:36px; color:var(--prev-text-main); font-weight:900; line-height:1; letter-spacing:-1px; text-shadow:0 0 25px var(--prev-accent-glow); margin-bottom:4px;">${formatCurrency(displayFinalPrice)}</div>
                                    
                                    ${conversion && conversion.enabled ? `
                                        <div style="font-size:10px; color:var(--prev-text-muted); font-weight:600; margin-top:-2px;">(approx. ${formatOriginal(originalFinalPrice)})</div>
                                    ` : ''}

                                    ${displaySavings > 0 ? `
                                        <div class="new-preview-savings-badge" style="margin-top:4px;">SAVE ${formatCurrency(displaySavings)}</div>
                                    ` : ''}
                                </div>
                                
                                ${(showPPC && ppcValue > 0) ? `<div style="margin-top:12px; border-top:1px dashed var(--prev-glass-border); padding-top:8px; font-size:10px; color:var(--prev-text-sec); font-family:monospace; text-align:center;">${formatCurrencyDecimal(ppcValue)} per class</div>` : ''}
                            </div>
                        `}
                        
                        ${referralHTML}

                        ${expiry ? `
                            <div style="margin-top:16px; display:flex; justify-content:center; flex-direction:column; align-items:center;">
                                <div style="border:1px solid var(--prev-glass-border); background:var(--prev-glass-bg); padding:6px 16px; border-radius:99px; font-size:9px; color:var(--prev-accent); font-weight:700; text-transform:uppercase; letter-spacing:1px; margin-bottom:2px;">
                                    ${expiry}
                                </div>
                                ${tcHtml}
                            </div>
                        ` : `
                            <div style="margin-top:16px;">
                                ${tcHtml}
                            </div>
                        `}
                    </div>
                </div>`;
        }

        function randomizeSvgIds(node) {
            const svgs = node.querySelectorAll('svg');
            svgs.forEach((svg) => {
                const defs = svg.querySelector('defs');
                if (defs) {
                    const grad = defs.querySelector('linearGradient');
                    if (grad && grad.id) {
                        const newId = grad.id + '-copy-' + Math.floor(Math.random() * 100000);
                        grad.id = newId;
                        const path = svg.querySelector('path');
                        if (path) {
                            const attr = path.getAttribute('stroke') && path.getAttribute('stroke').includes('url') ? 'stroke' : 'fill';
                            if (path.getAttribute(attr) && path.getAttribute(attr).includes('url')) {
                                path.setAttribute(attr, `url(#${newId})`);
                            }
                        }
                    }
                }
            });
        }

        async function copyCardForLaptop(cardId) {
            const btn = document.getElementById(`btn-copy-${cardId}`);
            const originalText = btn ? btn.innerHTML : '';
            if(btn) btn.innerHTML = '  Processing...';

            try {
                await document.fonts.ready;
                const wrapper = document.querySelector(`[data-card-id="${cardId}"]`);
                const source = wrapper ? wrapper.querySelector('.new-preview-card') : null;
                if (!source) throw new Error("Card source not found");

                const sandbox = document.createElement('div');
                sandbox.style.position = 'fixed';
                sandbox.style.left = '-10000px'; 
                sandbox.style.top = '0';
                sandbox.style.zIndex = '-9999'; 
                
                const clone = source.cloneNode(true);
                clone.style.transform = 'none';
                clone.style.margin = '0';
                clone.style.width = '320px';
                clone.style.minWidth = '320px';
                clone.style.maxWidth = '320px';
                clone.style.boxShadow = 'none'; 

                const container = document.createElement('div');
                container.style.width = '360px'; 
                container.style.padding = '20px'; 
                container.style.backgroundColor = '#ffffff'; 
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                
                container.appendChild(clone);
                sandbox.appendChild(container);
                randomizeSvgIds(clone); 
                document.body.appendChild(sandbox);

                await new Promise(r => setTimeout(r, 350)); 

                const dataUrl = await htmlToImage.toPng(container, {
                    quality: 1.0,
                    pixelRatio: 6, 
                    backgroundColor: '#ffffff', 
                    width: 360, 
                    cacheBust: true,
                    skipAutoScale: true
                });

                document.body.removeChild(sandbox);

                const res = await fetch(dataUrl);
                const blob = await res.blob();

                if (navigator.clipboard && navigator.clipboard.write) {
                    await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
                    showToast('  Copied High Quality Image!', 'success');
                } else {
                    throw new Error("Clipboard API unavailable");
                }

            } catch (error) {
                console.error("Copy failed", error);
                showToast('Copy Failed. Browser restricted.', 'error');
            } finally {
                if(btn) btn.innerHTML = originalText; 
            }
        }
        
        function showToast(message, type) {
            const existingToast = document.getElementById('screenshot-toast'); if (existingToast) existingToast.remove();
            const toast = document.createElement('div'); toast.id = 'screenshot-toast';
            toast.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${type === 'success' ? 'var(--save-color)' : '#ef4444'}; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 700; font-size: 0.9rem; z-index: 10000; box-shadow: 0 10px 40px rgba(0,0,0,0.3);`;
            toast.textContent = message; document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000);
        }

        function showTerms() { document.getElementById('terms-modal').style.display = 'block'; }
        function showCredits() { document.getElementById('credits-modal').style.display = 'block'; }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
        window.onclick = function(event) { 
            if (event.target.classList.contains('modal')) event.target.style.display = 'none'; 
            if (!event.target.closest('.timeline-vertical-box') && !event.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu[id^="roadmap-lbl-drop-"]').forEach(el => el.classList.add('hidden'));
            }
             if (!event.target.closest('.ds-row') && !event.target.closest('.dropdown-menu')) {
                document.querySelectorAll('.dropdown-menu[id^="discount-label-dropdown-"]').forEach(el => el.classList.add('hidden'));
            }
        }

        function wrapCollapsible(title, id, content, startOpen = false) {
            return `<div class="premium-card mb-4 ${startOpen?'':'collapsed'}"><div class="section-header-btn" onclick="toggleSection(this)"><h2 class="section-title mb-0">${title}</h2>${icons.chevron}</div><div id="${id}" class="collapsible-content ${startOpen?'':'hidden'}">${content}</div></div>`;
        }
        
        function toggleSection(btn) {
            const card = btn.closest('.premium-card'); const content = card.querySelector('.collapsible-content'); const chevron = btn.querySelector('.icon-chevron');
            content.classList.toggle('hidden'); card.classList.toggle('collapsed'); chevron.style.transform = content.classList.contains('hidden') ? 'rotate(-90deg)' : 'rotate(0deg)';
        }
        
        function toggleDropdownState(dropdownId) {
            document.querySelectorAll('.dropdown-menu').forEach(d => {
                if(d.id !== dropdownId) d.classList.add('hidden');
            });
            const dropdown = document.getElementById(dropdownId); if(!dropdown) return; 
            dropdown.classList.toggle('hidden');
        }
        
        function getRegionState(region) {
            if (!appState[region]) {
                const defRef = referralDefaults[region] || 20;
                appState[region] = {
                    full: { selected: [], defaults: [], referralSettings: { show: true, amount: defRef } },
                    customFd: { selected: [], defaults: [], referralSettings: { show: true, amount: defRef }, roadmapSettings: { rows: [] } },
                    customMs: { selected: [], defaults: [], referralSettings: { show: true, amount: defRef }, roadmapSettings: { rows: [] } },
                    
                    pricePerClassInControl: {}, customCouponTypes: {}, customDiscountLabels: {}, showPPCInOutput: {}, conversionEnabled: {}, conversionShowInOutput: {},
                    bannerSettings: { showBanner: false, bannerTextSingle: 'Limited seats!', bannerTextBundle: 'Max Savings!' }, 
                    ppcSettings: { useTarget: false }, 
                    showDiscountPercent: false,
                    priceLabelType: 'TOTAL INVESTMENT',
                    roadmapData: { count: 3 } 
                };
                StudentNameController.init(region, 'full');
                StudentNameController.init(region, 'foundation');
                StudentNameController.init(region, 'masters');
                StudentNameController.init(region, 'autoPricer');
            }
            return appState[region];
        }

        const PPCController = {
            states: {},
            init: function(region, idPrefix) { if(this.states[`${region}-${idPrefix}`] === undefined) this.states[`${region}-${idPrefix}`] = false; },
            isUnlocked: function(region, idPrefix) { return !!this.states[`${region}-${idPrefix}`]; },
            toggle: function(region, idPrefix) { const key = `${region}-${idPrefix}`; this.states[key] = !this.states[key]; this.renderState(region, idPrefix); if (!this.states[key]) { idPrefix === 'full' ? recalcFullOffers(region) : calculateCustomPackage(region, idPrefix); } },
            renderState: function(region, idPrefix) { const isUnlocked = this.isUnlocked(region, idPrefix); const btn = document.getElementById(`lock-ppc-btn-${idPrefix}-${region}`); const input = document.getElementById(`ppc-input-${idPrefix}-${region}`); if(btn && input) { input.disabled = !isUnlocked; btn.classList.toggle('unlocked', isUnlocked); btn.innerHTML = isUnlocked ? `${icons.unlock}` : `${icons.lock}`; input.classList.toggle('text-accent', isUnlocked); } },
            calculateTargetDiscount: function(region, idPrefix, inputPPC) { 
                if (inputPPC < 0) return 0; 
                const totalClasses = getCurrentTotalClasses(region, idPrefix); 
                const fullPrice = getCurrentFullPrice(region, idPrefix); 
                if (totalClasses <= 0 || fullPrice <= 0) return 0; 

                const rs = getRegionState(region);
                const useTarget = rs.ppcSettings && rs.ppcSettings.useTarget;
                const targetCurrency = rs.conversionEnabled[`${region}-${idPrefix}`];
                
                let targetFinalBase = 0;

                if (useTarget && targetCurrency && globalConversionRates) {
                    const targetTotal = inputPPC * totalClasses; 
                    const baseCode = conversionCurrencies[region].code;
                    const convertedBaseTotal = convertPrice(targetTotal, targetCurrency, baseCode);
                    if (convertedBaseTotal !== null) {
                         targetFinalBase = convertedBaseTotal;
                    } else {
                         targetFinalBase = inputPPC * totalClasses; 
                    }
                } else {
                    targetFinalBase = inputPPC * totalClasses;
                }
                
                return Math.max(0, Math.min(99, (1 - (targetFinalBase / fullPrice)) * 100)); 
            },
            handleInput: function(region, idPrefix) { if (!this.isUnlocked(region, idPrefix)) return; const inputVal = parseFloat(document.getElementById(`ppc-input-${idPrefix}-${region}`)?.value); if (isNaN(inputVal)) return; const totalPercent = this.calculateTargetDiscount(region, idPrefix, inputVal); this.distributeDiscounts(region, idPrefix, totalPercent); idPrefix === 'full' ? recalcFullOffers(region) : calculateCustomPackage(region, idPrefix); },
            distributeDiscounts: function(region, idPrefix, totalPercent) { 
                const types = ['normal', 'mgmt']; 
                let enabled = types.filter(t => document.getElementById(`discount-enable-${t}-${idPrefix}-${region}`)?.checked); 
                
                if (enabled.length === 0) { 
                    const normalCheck = document.getElementById(`discount-enable-normal-${idPrefix}-${region}`); 
                    if(normalCheck) { normalCheck.checked = true; enabled.push('normal'); } 
                } 
                
                const perInput = totalPercent / enabled.length; 
                types.forEach(t => { 
                    const el = document.getElementById(`discount-input-${t}-${idPrefix}-${region}`); 
                    if(el) el.value = enabled.includes(t) ? perInput.toFixed(2) : 0; 
                }); 
            },
            maintainFromDiscountAdjustment: function(region, idPrefix, changedType) { 
                if(changedType === 'referral') return;

                const input = document.getElementById(`ppc-input-${idPrefix}-${region}`); 
                const inputVal = parseFloat(input?.value || 0); 
                if (isNaN(inputVal)) return; 
                const totalRequired = this.calculateTargetDiscount(region, idPrefix, inputVal); 
                
                const changedInputEl = document.getElementById(`discount-input-${changedType}-${idPrefix}-${region}`); 
                let changedVal = parseFloat(changedInputEl?.value) || 0; 
                
                if (changedVal > totalRequired) { 
                    changedVal = totalRequired; 
                    if(changedInputEl) changedInputEl.value = changedVal.toFixed(2); 
                } 
                
                const remainingPercent = totalRequired - changedVal; 
                const types = ['normal', 'mgmt']; 
                const enabled = types.filter(t => document.getElementById(`discount-enable-${t}-${idPrefix}-${region}`)?.checked); 
                const others = enabled.filter(t => t !== changedType); 
                
                if (others.length > 0) { 
                    const perOther = remainingPercent / others.length; 
                    others.forEach(t => { 
                        const el = document.getElementById(`discount-input-${t}-${idPrefix}-${region}`); 
                        if(el) el.value = Math.max(0, perOther).toFixed(2); 
                    }); 
                } 
            },
            updateDisplay: function(region, idPrefix, finalPrice, totalClasses) { 
                if (this.isUnlocked(region, idPrefix)) return; 
                const input = document.getElementById(`ppc-input-${idPrefix}-${region}`); 
                const label = document.getElementById(`ppc-status-text-${idPrefix}-${region}`);
                if (!input) return;

                const rs = getRegionState(region);
                const useTarget = rs.ppcSettings && rs.ppcSettings.useTarget;
                const targetCurrency = rs.conversionEnabled[`${region}-${idPrefix}`];
                
                let displayPrice = finalPrice;
                let currencyLabel = "Calculated from discounts";

                if (useTarget && targetCurrency && globalConversionRates) {
                    const baseCode = conversionCurrencies[region].code;
                    const convertedTotal = convertPrice(finalPrice, baseCode, targetCurrency);
                    if (convertedTotal !== null) {
                        displayPrice = convertedTotal;
                        currencyLabel = `Calculated in ${targetCurrency}`;
                    }
                }
                
                if(label) label.textContent = currencyLabel;
                input.value = totalClasses > 0 ? (displayPrice / totalClasses).toFixed(2) : 0; 
            }
        };

        const ConverterController = {
            updatePreview: function(region, idPrefix, dynamicAmount = null) { 
                const targetEl = document.getElementById(`conversion-target-${idPrefix}-${region}`); if(!targetEl) return;
                const resultPreview = document.getElementById(`conversion-result-preview-${idPrefix}-${region}`);
                const ppcCheck = document.getElementById(`ppc-use-target-${idPrefix}-${region}`);
                
                if(!resultPreview) return;
                const baseCode = conversionCurrencies[region].code; const target = targetEl.value;
                
                if (ppcCheck) {
                    if (!target || target === baseCode) {
                        ppcCheck.disabled = true;
                        ppcCheck.checked = false;
                        getRegionState(region).ppcSettings.useTarget = false;
                    } else {
                        ppcCheck.disabled = false;
                    }
                }

                if (!globalConversionRates || !target || target === baseCode) { resultPreview.textContent = '--'; return; }
                const baseAmount = dynamicAmount !== null && dynamicAmount > 0 ? dynamicAmount : 0;
                const converted = convertPrice(baseAmount, baseCode, target);
                if (converted !== null) {
                    const targetSymbol = Object.values(conversionCurrencies).find(c => c.code === target).symbol;
                    resultPreview.innerHTML = `${targetSymbol}${Math.floor(converted).toLocaleString()}`;
                } else resultPreview.textContent = '--';
            },
            triggerUpdate: function(region, idPrefix) { 
                const rs = getRegionState(region); 
                rs.conversionEnabled[`${region}-${idPrefix}`] = document.getElementById(`conversion-target-${idPrefix}-${region}`)?.value; 
                rs.conversionShowInOutput[`${region}-${idPrefix}`] = document.getElementById(`conversion-show-${idPrefix}-${region}`)?.checked;
                
                const ppcCheck = document.getElementById(`ppc-use-target-${idPrefix}-${region}`);
                if (ppcCheck) rs.ppcSettings.useTarget = ppcCheck.checked;

                if (idPrefix === 'full') recalcFullOffers(region); 
                else calculateCustomPackage(region, idPrefix); 
            }
        };

        function getDefaultExpiry() { const now = new Date(); now.setDate(now.getDate() + 3); now.setHours(23, 59, 0, 0); const offset = now.getTimezoneOffset(); return new Date(now.getTime() - (offset*60*1000)).toISOString().slice(0,16); }
        function formatExpiry(dateTimeLocalValue) { if (!dateTimeLocalValue) return "No Expiry"; try { return `Valid till: ${new Date(dateTimeLocalValue).toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}`; } catch (e) { return `Valid till: ${dateTimeLocalValue}`; } }
        function generateCoupon(type) { 
            const randomSuffix = Math.floor(100 + Math.random() * 900); 
            return `${type}${randomSuffix}`; 
        }
        function formatCurrency(value, currency, showDecimals = false) { let num = Math.abs(value); if (!showDecimals) num = Math.floor(num); return `${currency}${num.toLocaleString(currency === ' ' ? 'en-IN' : undefined, { minimumFractionDigits: showDecimals ? 2 : 0, maximumFractionDigits: showDecimals ? 2 : 0 })}`; }
        function updateText(id, value) { const el = document.getElementById(id); if (el) el.innerHTML = value; }
        function toggleVisibility(id, show) { const el = document.getElementById(id); if (el) show ? el.classList.remove('hidden') : el.classList.add('hidden'); }
        function getActiveDiscounts(region, idPrefix) { 
            const isChecked = (type) => document.getElementById(`discount-enable-${type}-${idPrefix}-${region}`)?.checked;
            const getVal = (type) => isChecked(type) ? (parseFloat(document.getElementById(`discount-input-${type}-${idPrefix}-${region}`)?.value) || 0) : 0;
            return { normal: getVal('normal'), mgmt: getVal('mgmt'), referral: getVal('referral') }; 
        }
        function getSubLevelCode(level, subIndex) { const maps = { beginner: 'B', adv_beginner: 'AB', intermediate: 'I', adv_part_1: 'A', adv_part_2: 'A', sub_junior: 'SJR', junior: 'JR', senior_part_1: 'SR', senior_part_2: 'SR' }; return `${maps[level]}${subIndex}`; }
        function handleBannerChange(region, type, value, idPrefix) { 
            const rs = getRegionState(region); 
            if (type === 'toggle') {
                rs.bannerSettings.showBanner = document.getElementById(`banner-toggle-${idPrefix}-${region}`).checked;
            } else if (type === 'single') rs.bannerSettings.bannerTextSingle = value; 
            else if (type === 'bundle') rs.bannerSettings.bannerTextBundle = value; 
            currentActiveTab === 'full' ? renderFullOffers(region) : calculateCustomPackage(region, currentActiveTab === 'custom-fd' ? 'foundation' : 'masters'); 
        }
        function handleDiscountPercentToggle(region) { const rs = getRegionState(region); rs.showDiscountPercent = document.getElementById(`discount-percent-toggle-${region}`).checked; currentActiveTab === 'full' ? renderFullOffers(region) : calculateCustomPackage(region, currentActiveTab === 'custom-fd' ? 'foundation' : 'masters'); }
        function togglePriceLabel(region, checkbox) { const rs = getRegionState(region); rs.priceLabelType = checkbox.checked ? 'YOUR PRICE' : 'TOTAL INVESTMENT'; currentActiveTab === 'full' ? renderFullOffers(region) : calculateCustomPackage(region, currentActiveTab === 'custom-fd' ? 'foundation' : 'masters'); }
        
        function handleReferralChange(region, type, value, idPrefix) {
            const rs = getRegionState(region);
            let stateKey = 'full';
            if(idPrefix === 'foundation') stateKey = 'customFd';
            if(idPrefix === 'masters') stateKey = 'customMs';
            
            if (type === 'toggle') {
                rs[stateKey].referralSettings.show = document.getElementById(`referral-show-toggle-${idPrefix}-${region}`).checked;
            } else if (type === 'amount') {
                rs[stateKey].referralSettings.amount = value;
            }
            
            if(idPrefix === 'full') renderFullOffers(region);
            else calculateCustomPackage(region, idPrefix);
        }

        function toggleCostBreakdown(region, idPrefix) {
            const panel = document.getElementById(`cost-breakdown-panel-${idPrefix}-${region}`);
            const btn = document.getElementById(`breakdown-btn-${idPrefix}-${region}`);
            if(panel) {
                panel.classList.toggle('hidden');
                if(btn) btn.innerHTML = panel.classList.contains('hidden') 
                    ? `See Cost Breakdown ${icons.chevron}` 
                    : `Hide Breakdown ${icons.chevron}`;
            }
        }
        
        function handleRoadmapToggle(region, idPrefix) {
            const isChecked = document.getElementById(`roadmap-show-toggle-${idPrefix}-${region}`).checked;
            const container = document.getElementById(`roadmap-container-${idPrefix}-${region}`);
            
            const rs = getRegionState(region);
            if(!rs.roadmapData) rs.roadmapData = {};
            rs.roadmapData[`${idPrefix}-show`] = isChecked;

            if(isChecked) container.classList.remove('hidden');
            else container.classList.add('hidden');
            
            calculateCustomPackage(region, idPrefix);
        }

        function selectRoadmapLabel(region, idPrefix, rowNum, label) {
            const val = label === 'CUSTOM' ? (prompt('Enter custom tier name:') || '').trim() : label;
            if (!val && label === 'CUSTOM') return;

            document.getElementById(`roadmap-lbl-display-${rowNum}-${idPrefix}-${region}`).textContent = val;
            document.getElementById(`roadmap-label-${rowNum}-${idPrefix}-${region}`).value = val;

            const rs = getRegionState(region);
            if(!rs.roadmapData) rs.roadmapData = {};
            rs.roadmapData[`${idPrefix}-${rowNum}-label`] = val;

            toggleDropdownState(`roadmap-lbl-drop-${rowNum}-${idPrefix}-${region}`);
            calculateCustomPackage(region, idPrefix);
        }

        function formatRoadmapDate(dateString) {
            if(!dateString) return "";
            const d = new Date(dateString);
            if(isNaN(d.getTime())) return dateString;
            const day = d.getDate();
            const month = d.toLocaleString('default', { month: 'short' });
            const nth = (d) => {
                if (d > 3 && d < 21) return 'th';
                switch (d % 10) {
                    case 1:  return "st";
                    case 2:  return "nd";
                    case 3:  return "rd";
                    default: return "th";
                }
            };
            return `${day}${nth(day)} ${month}`;
        }

        function addTimelineRow(region, idPrefix) {
            const rs = getRegionState(region);
            if(!rs.roadmapData) rs.roadmapData = { count: 3 };
            if(rs.roadmapData.count < 5) {
                rs.roadmapData.count++;
                renderTimelineContainer(region, idPrefix);
                calculateCustomPackage(region, idPrefix);
            }
        }

        function removeTimelineRow(region, idPrefix) {
            const rs = getRegionState(region);
            if(!rs.roadmapData) rs.roadmapData = { count: 3 };
            if(rs.roadmapData.count > 1) {
                rs.roadmapData.count--;
                renderTimelineContainer(region, idPrefix);
                calculateCustomPackage(region, idPrefix);
            }
        }

        function renderTimelineContainer(region, idPrefix) {
            const container = document.getElementById(`roadmap-dynamic-wrapper-${idPrefix}-${region}`);
            if(!container) return;
            
            const rs = getRegionState(region);
            const count = rs.roadmapData ? (rs.roadmapData.count || 3) : 3;
            
            const roadmapPresets = ['Super Early Bird', 'Early Bird', 'Round 1', 'Round 2', 'Expiry', 'Standard', 'Last Call', 'CUSTOM'];
            let html = '';

            for(let i=1; i<=count; i++) {
                const rowOpts = roadmapPresets.map(l => 
                    `<div class="dropdown-item" onclick="selectRoadmapLabel('${region}', '${idPrefix}', ${i}, '${l}')">${l}</div>`
                ).join('');

                let defaultLabel = 'Tier ' + i;
                if (count === 2) {
                    defaultLabel = (i === 1) ? 'Early Bird' : 'Standard';
                } else if (count === 3) {
                    if(i===1) defaultLabel = 'Super Early Bird';
                    else if(i===2) defaultLabel = 'Early Bird';
                    else defaultLabel = 'Standard';
                }

                const currentLabel = rs.roadmapData?.[`${idPrefix}-${i}-label`] || defaultLabel;
                
                let existDate = '', existPercent = (i===1?10:(i===2?5:0));
                const oldDateEl = document.getElementById(`roadmap-date-${i}-${idPrefix}-${region}`);
                const oldPercEl = document.getElementById(`roadmap-percent-${i}-${idPrefix}-${region}`);
                if(oldDateEl) existDate = oldDateEl.value;
                if(oldPercEl) existPercent = oldPercEl.value;

                html += `
                <div class="timeline-vertical-box relative animate-[fadeIn_0.3s_ease]">
                    <div class="relative w-full">
                        <label class="text-[0.6rem] font-bold text-secondary uppercase mb-1 block">Tier Name</label>
                        <div class="fs-light-input cursor-pointer flex justify-between items-center bg-white" onclick="toggleDropdownState('roadmap-lbl-drop-${i}-${idPrefix}-${region}')">
                            <span id="roadmap-lbl-display-${i}-${idPrefix}-${region}" class="text-xs font-bold text-accent truncate">${currentLabel}</span>
                            <svg class="w-3 h-3 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </div>
                        <input type="hidden" id="roadmap-label-${i}-${idPrefix}-${region}" value="${currentLabel}">
                        <div id="roadmap-lbl-drop-${i}-${idPrefix}-${region}" class="dropdown-menu hidden" style="width:100%; top:100%; left:0;">${rowOpts}</div>
                    </div>
                    
                    <div class="timeline-row-grid">
                        <div>
                            <label class="text-[0.6rem] font-bold text-secondary uppercase mb-1 block">Ends On</label>
                            <input type="date" id="roadmap-date-${i}-${idPrefix}-${region}" class="fs-light-input" value="${existDate}" onchange="calculateCustomPackage('${region}', '${idPrefix}')">
                        </div>
                        <div>
                            <label class="text-[0.6rem] font-bold text-secondary uppercase mb-1 block">Disc %</label>
                            <input type="number" id="roadmap-percent-${i}-${idPrefix}-${region}" class="fs-light-input text-center font-bold text-accent" placeholder="0" value="${existPercent}" oninput="calculateCustomPackage('${region}', '${idPrefix}')">
                        </div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
        }

        function createFinancialSuiteHTML(region, idPrefix) {
            PPCController.init(region, idPrefix);
            
            const lblOpts = discountLabels.map(l => `<div class="dropdown-item" onclick="selectDiscountLabel('${region}', '${idPrefix}', '${l}')">${l}</div>`).join('');
            
            let currencyOpts = `<option value="">Select Target Currency</option>`;
            Object.entries(conversionCurrencies).forEach(([key, info]) => {
                if(info.code !== allPrices[region].currency)
                    currencyOpts += `<option value="${info.code}">${info.name} (${info.code})</option>`; 
            });
            
            const rs = getRegionState(region);
            let stateKey = idPrefix === 'foundation' ? 'customFd' : 'customMs';
            const defaultRefAmount = rs[stateKey].referralSettings.amount;

            setTimeout(() => renderTimelineContainer(region, idPrefix), 0);

            return `
            <div class="fs-light-container">
                <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-[rgba(125,125,125,0.1)]">
                    <div class="p-5 flex flex-col justify-center relative">
                        <div class="flex justify-between items-center mb-1">
                            <span class="fs-label">Price Per Class</span>
                            <button type="button" id="lock-ppc-btn-${idPrefix}-${region}" class="fs-btn-lock" onclick="PPCController.toggle('${region}', '${idPrefix}')" title="Unlock to edit manually">${icons.lock}</button>
                        </div>
                        <div class="fs-wrapper relative">
                            <span class="fs-currency">${allPrices[region].currency}</span>
                            <input type="number" id="ppc-input-${idPrefix}-${region}" class="fs-input-huge" placeholder="0" oninput="PPCController.handleInput('${region}', '${idPrefix}')" step="0.01" disabled>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <span id="ppc-status-text-${idPrefix}-${region}" class="text-[0.65rem] text-secondary">Auto-calculated</span>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <span class="text-[0.6rem] font-bold uppercase text-accent">Show on Card</span>
                                <label class="toggle-switch small"><input type="checkbox" ${appState[region] && appState[region].showPPCInOutput[`${region}-${idPrefix}`]?'checked':''} onchange="togglePPCVisibility('${region}', '${idPrefix}')"><span class="toggle-slider"></span></label>
                            </label>
                        </div>
                        <button type="button" id="breakdown-btn-${idPrefix}-${region}" onclick="toggleCostBreakdown('${region}', '${idPrefix}')" class="mt-3 text-[0.7rem] text-accent font-bold flex items-center gap-1 hover:underline">See Breakdown ${icons.chevron}</button>
                        <div id="cost-breakdown-panel-${idPrefix}-${region}" class="hidden mt-3 p-3 bg-[rgba(125,125,125,0.05)] rounded border border-[var(--input-border)] text-xs"><div id="psl-display-${idPrefix}-${region}" class="text-secondary italic">Select levels to see breakdown.</div></div>
                    </div>
                    
                    <div class="p-5 flex flex-col justify-center bg-[rgba(125,125,125,0.02)]">
                        <span class="fs-label mb-2">Currency Converter</span>
                        <select id="conversion-target-${idPrefix}-${region}" class="fs-light-input mb-3 bg-white" style="font-size:0.85rem;" onchange="ConverterController.triggerUpdate('${region}', '${idPrefix}')">${currencyOpts}</select>
                        <div class="flex items-center justify-between mt-1">
                            <span class="text-[0.65rem] text-secondary uppercase font-bold">Converted Total</span>
                            <div id="conversion-result-preview-${idPrefix}-${region}" class="text-xl font-black text-accent">--</div>
                        </div>
                        <div class="mt-4 flex flex-col gap-2">
                             <label class="flex items-center justify-between cursor-pointer"><span class="text-xs font-bold text-secondary font-bold">Show in Preview</span><label class="toggle-switch small"><input type="checkbox" id="conversion-show-${idPrefix}-${region}" onchange="ConverterController.triggerUpdate('${region}', '${idPrefix}')"><span class="toggle-slider"></span></label></label>
                             <label class="flex items-center justify-between cursor-pointer opacity-70 hover:opacity-100"><span class="text-[0.7rem] text-secondary font-bold">Drive Price by Target</span><label class="toggle-switch small"><input type="checkbox" id="ppc-use-target-${idPrefix}-${region}" disabled onchange="ConverterController.triggerUpdate('${region}', '${idPrefix}')"><span class="toggle-slider"></span></label></label>
                        </div>
                    </div>
                </div>

                <div class="p-0 border-t border-[rgba(125,125,125,0.1)]">
                    <div class="p-4 pb-2"><h3 class="fs-label" style="color:var(--text-1);">Discount Stack</h3></div>
                    <div class="ds-container">
                        <div class="ds-row">
                            <label class="toggle-switch small"><input type="checkbox" id="discount-enable-normal-${idPrefix}-${region}" onchange="handleDiscountChange('${region}', '${idPrefix}', 'normal')"><span class="toggle-slider"></span></label>
                            <span class="ds-label text-[#34d399]">Coupon Code</span>
                            <div class="flex items-center"><input type="number" id="discount-input-normal-${idPrefix}-${region}" value="10" class="ds-input text-[#34d399]" oninput="handleDiscountChange('${region}', '${idPrefix}', 'normal')"><span class="text-lg font-bold text-[#34d399] ml-1">%</span></div>
                        </div>
                        <div class="ds-row relative">
                            <label class="toggle-switch small"><input type="checkbox" id="discount-enable-mgmt-${idPrefix}-${region}" onchange="handleDiscountChange('${region}', '${idPrefix}', 'mgmt')"><span class="toggle-slider"></span></label>
                            <div class="flex items-center flex-wrap gap-1 relative">
                                <span class="ds-label text-[#60a5fa]" id="discount-label-display-${idPrefix}-${region}">Management Discount</span>
                                <button type="button" class="ds-edit-btn" onclick="toggleDropdownState('discount-label-dropdown-${idPrefix}-${region}')">Edit</button>
                                <div id="discount-label-dropdown-${idPrefix}-${region}" class="dropdown-menu hidden" style="left:0; top:100%; width:200px;">${lblOpts}</div>
                            </div>
                            <div class="flex items-center"><input type="number" id="discount-input-mgmt-${idPrefix}-${region}" value="0" class="ds-input text-[#60a5fa]" oninput="handleDiscountChange('${region}', '${idPrefix}', 'mgmt')"><span class="text-lg font-bold text-[#60a5fa] ml-1">%</span></div>
                        </div>
                        <div class="ds-row">
                            <label class="toggle-switch small"><input type="checkbox" id="discount-enable-referral-${idPrefix}-${region}" onchange="handleDiscountChange('${region}', '${idPrefix}', 'referral')"><span class="toggle-slider"></span></label>
                            <span class="ds-label text-[#f472b6]">Referral Bonus</span>
                            <div class="flex items-center"><input type="number" id="discount-input-referral-${idPrefix}-${region}" value="0" class="ds-input text-[#f472b6]" oninput="handleDiscountChange('${region}', '${idPrefix}', 'referral')"><span class="text-sm font-bold text-[#f472b6] ml-1 uppercase" style="min-width:24px;">${allPrices[region].currency}</span></div>
                        </div>
                    </div>
                </div>

                <div class="p-5 border-t border-[rgba(125,125,125,0.1)]">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="fs-label" style="color:var(--text-1);">Enrollment Timeline</h3>
                        <label class="toggle-switch small">
                            <input type="checkbox" id="roadmap-show-toggle-${idPrefix}-${region}" onchange="handleRoadmapToggle('${region}', '${idPrefix}')">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    
                    <div id="roadmap-container-${idPrefix}-${region}" class="hidden transition-all duration-300 mb-5 bg-[rgba(125,125,125,0.02)] rounded-lg p-3 border border-[var(--input-border)]">
                        <div class="flex justify-end gap-2 mb-2">
                            <button type="button" class="add-remove-btn" onclick="removeTimelineRow('${region}', '${idPrefix}')" title="Remove Row">-</button>
                            <button type="button" class="add-remove-btn" onclick="addTimelineRow('${region}', '${idPrefix}')" title="Add Row">+</button>
                        </div>
                        <div id="roadmap-dynamic-wrapper-${idPrefix}-${region}"></div>
                    </div>

                    <div class="bg-[rgba(125,125,125,0.05)] rounded-lg p-3 border border-[var(--input-border)] flex flex-wrap md:flex-nowrap items-center gap-4">
                        <div class="flex items-center gap-2 min-w-[140px]">
                            <span class="text-[0.65rem] font-bold text-secondary uppercase">Referral Badge</span>
                            <label class="toggle-switch small"><input type="checkbox" id="referral-show-toggle-${idPrefix}-${region}" checked onchange="handleReferralChange('${region}', 'toggle', '', '${idPrefix}')"><span class="toggle-slider"></span></label>
                        </div>
                        <input type="text" id="referral-amount-input-${idPrefix}-${region}" class="fs-light-input bg-white" style="font-size:0.8rem;" placeholder="Amount (e.g. 500)" value="${defaultRefAmount}" oninput="handleReferralChange('${region}', 'amount', this.value, '${idPrefix}')">
                    </div>
                </div>
            </div>`; 
        }

        function createCalculatorHTML(region) {
            const data = allPrices[region]; if(!data) return '';
            const cOpts = couponTypes.map(t => `<div class="dropdown-item" onclick="selectCouponType('${region}', 'full', '${t}')">${t}</div>`).join('');
            
            const rs = getRegionState(region);
            const defaultRef = rs.full.referralSettings.amount;
            
            const bannerChecked = rs.bannerSettings.showBanner ? 'checked' : '';

            const classTypeToggle = `<div class="class-type-switch"><div class="switch-bg"></div><input type="radio" class="class-type-input" id="type-one-${region}" name="class-type-global-${region}" value="one_on_one" checked onchange="switchClassType('${region}', 'one_on_one')"><label for="type-one-${region}" class="class-type-label"><span class="text-xl">  </span> One-on-One</label><input type="radio" class="class-type-input" id="type-group-${region}" name="class-type-global-${region}" value="group" onchange="switchClassType('${region}', 'group')"><label for="type-group-${region}" class="class-type-label"><span class="text-xl"> </span> Group Class</label></div>`;
            
            const discountContent = `
                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                    <label class="flex items-center gap-2 cursor-pointer"><span class="text-xs font-bold text-accent uppercase">Show Discount %</span><label class="toggle-switch"><input type="checkbox" id="discount-percent-toggle-${region}" checked onchange="handleDiscountPercentToggle('${region}')"><span class="toggle-slider"></span></label></label>
                    <label class="flex items-center gap-2 cursor-pointer"><span class="text-xs font-bold text-accent uppercase">Label: Your Price</span><label class="toggle-switch"><input type="checkbox" id="price-label-toggle-${region}" onchange="togglePriceLabel('${region}', this)"><span class="toggle-slider"></span></label></label>
                </div>
                
                <div class="mb-4 p-4 rounded-xl border border-[var(--input-border)] bg-[rgba(125,125,125,0.05)]">
                    <h3 class="text-xs font-bold text-accent mb-3 uppercase tracking-wider">Referral Badge</h3>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer"><span class="text-xs font-bold text-secondary uppercase">Show</span><label class="toggle-switch small"><input type="checkbox" id="referral-show-toggle-full-${region}" checked onchange="handleReferralChange('${region}', 'toggle', '', 'full')"><span class="toggle-slider"></span></label></label>
                        <input type="text" id="referral-amount-input-full-${region}" class="input-premium py-1 px-3 text-sm flex-grow" placeholder="Amount (e.g. 500)" value="${defaultRef}" oninput="handleReferralChange('${region}', 'amount', this.value, 'full')">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="p-4 rounded-xl border border-[var(--input-border)] bg-[rgba(125,125,125,0.05)]"><h3 class="text-xs font-bold text-accent mb-3 uppercase tracking-wider">Single Level</h3><div class="flex flex-col gap-3">${createDiscountInputBlock(region, 'full_single')}</div></div><div class="p-4 rounded-xl border border-[var(--input-border)] bg-[rgba(125,125,125,0.05)]"><h3 class="text-xs font-bold text-accent mb-3 uppercase tracking-wider">Bundle</h3><div class="flex flex-col gap-3">${createDiscountInputBlock(region, 'full_bundle')}</div></div></div>`;
            
            const couponContent = `
                ${StudentNameController.renderControls(region, 'full')}
                <div class="flex items-center justify-between mb-3"><label class="block text-xs font-bold text-accent uppercase">Enable Coupon</label><label class="toggle-switch"><input type="checkbox" id="coupon-enable-${region}" onchange="recalcFullOffers('${region}')"><span class="toggle-slider"></span></label></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                    <div class="discount-control relative"><label class="block text-xs font-bold text-accent mb-2 uppercase">Coupon Type</label><div class="flex items-center gap-2"><button type="button" onclick="showCouponTypeDropdown('${region}', 'full')" class="input-premium flex items-center justify-between cursor-pointer"><span id="coupon-type-display-full-${region}">LOYALTY</span><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><div id="coupon-type-dropdown-full-${region}" class="dropdown-menu hidden">${cOpts}</div></div>
                    <div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">Expiry</label><input type="datetime-local" id="coupon-expiry-${region}" value="${getDefaultExpiry()}" class="input-premium"></div>
                </div>
                <div class="mt-4 border-t border-[var(--header-border)] pt-4">
                    <div class="flex items-center justify-between mb-3"><span class="text-xs font-bold text-accent uppercase">Urgency Banner</span><label class="toggle-switch"><input type="checkbox" id="banner-toggle-full-${region}" ${bannerChecked} onchange="handleBannerChange('${region}', 'toggle', '', 'full')"><span class="toggle-slider"></span></label></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="discount-control"><label class="block text-[0.65rem] font-bold text-secondary mb-1 uppercase">Standard Text</label><input type="text" class="input-premium text-sm" value="Limited seats!" oninput="handleBannerChange('${region}', 'single', this.value, 'full')"></div>
                        <div class="discount-control"><label class="block text-[0.65rem] font-bold text-secondary mb-1 uppercase">Highlight Text</label><input type="text" class="input-premium text-sm" value="Max Savings!" oninput="handleBannerChange('${region}', 'bundle', this.value, 'full')"></div>
                    </div>
                </div>`;
            
            const cardsSection = `<div class="premium-card mb-6"><h2 class="section-title mb-4">  Offers</h2><div class="mb-5 bg-[var(--input-bg)] p-4 rounded-xl border border-[var(--input-border)]"><label class="block text-xs font-bold text-accent mb-2 uppercase">Start From:</label><select id="upsell-filter-${region}" onchange="renderFullOffers('${region}')" class="input-premium max-w-md"><option value="none">-- Select Starting Level --</option><optgroup label="Foundation">${foundationLevels.map(l => `<option value="${l}">${foundationLevelNames[l]}</option>`).join('')}</optgroup><optgroup label="Masters">${mastersLevels.map(l => `<option value="${l}_partial">${mastersLevelNames[l]} (48 Sessions)</option><option value="${l}">${mastersLevelNames[l]} (96 Sessions)</option>`).join('')}</optgroup></select></div><div id="offers-output-container-${region}" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div></div>`;
            
            return `
                <div class="premium-card mb-5">
                    <h1 class="text-3xl font-black text-primary mb-5 flex items-center gap-3">${regionNames[region]}</h1>
                    <div class="tab-container">
                        <button id="tab-btn-full-${region}" class="tab-btn active" onclick="showInternalTab('${region}', 'full')">⚡ Quick Offers</button>
                        <button id="tab-btn-custom-fd-${region}" class="tab-btn" onclick="showInternalTab('${region}', 'custom-fd')">♟️ Custom Foundation</button>
                        <button id="tab-btn-custom-ms-${region}" class="tab-btn" onclick="showInternalTab('${region}', 'custom-ms')">👑 Custom Masters</button>
                        <button id="tab-btn-global-conv-${region}" class="tab-btn" onclick="showInternalTab('${region}', 'global-conv')">💱 Converter</button>
                        <button id="tab-btn-auto-pricer-${region}" class="tab-btn" onclick="showInternalTab('${region}', 'auto-pricer')">🤖 Helper</button>
                    </div>
                </div>
                <div id="tab-content-full-${region}">
                    ${classTypeToggle}
                    ${wrapCollapsible('⚙️ Pricing Control', `col-pricing-${region}`, discountContent)}
                    ${wrapCollapsible('🎟️ Coupon Options', `col-coupon-${region}`, couponContent)}
                    ${wrapCollapsible('💱 Price Converter', `col-converter-${region}`, createPriceConverterHTML(region, 'full'))}
                    ${wrapCollapsible('🎨 Manage Benefits', `col-benefits-${region}`, createBenefitsManagerHTML(region, 'full'))}
                    ${cardsSection}
                </div>
                <div id="tab-content-auto-pricer-${region}" class="hidden">${generateAutoPricerHTML(region)}</div>
                <div id="tab-content-custom-fd-${region}" class="hidden">${generateCustomCalc(region, 'foundation', data.foundation.groupName, region==='in'?data.foundation.groupName2:null)}</div>
                <div id="tab-content-custom-ms-${region}" class="hidden">${generateCustomCalc(region, 'masters', data.masters.groupName, null)}</div>
                <div id="tab-content-global-conv-${region}" class="hidden">${generateGlobalConverterHTML(region)}</div>`;
        }

        function switchClassType(region, type) { renderFullOffers(region); }
        function handleDiscountChange(region, idPrefix, type) { if (idPrefix.startsWith('full')) { recalcFullOffers(region); return; } if (PPCController.isUnlocked(region, idPrefix)) { PPCController.maintainFromDiscountAdjustment(region, idPrefix, type); } calculateCustomPackage(region, idPrefix); }

        function calculatePackageData(region, startIdx, endIdx, fdKey, msKey, forcePartialLast = false) {
            let totalClasses = 0, totalMonths = 0, totalPrice = 0, levelNames = [], levelsInfo = [];
            for (let i = startIdx; i <= endIdx; i++) {
                const item = fullLevelSequence[i]; 
                
                if (item.type === 'foundation') {
                    levelNames.push(item.name);
                    let sText = 'Full Level';
                    if(item.key === 'adv_part_1') sText = 'A1, A2, A3';
                    if(item.key === 'adv_part_2') sText = 'A4, A5, A6';
                    levelsInfo.push({ name: item.name, subLevels: sText });
                    const str = classStructure[`foundation_${(fdKey==='regular_group'||fdKey==='focused_group')?'group':fdKey}`];
                    totalClasses += str.total; totalMonths += str.duration; totalPrice += allPrices[region].foundation[fdKey][item.key];
                } else {
                    const str = classStructure[`masters_${msKey}`];
                    const isLast = (i === endIdx);
                    const usePartial = isLast && forcePartialLast;
                    
                    let suffix = usePartial ? " (Partial)" : "";
                    levelNames.push(item.name + suffix);
                    
                    let subText = usePartial ? "SJR1, SJR2, SJR3" : "Full Level (1-6)"; 
                    if (item.key === 'junior') subText = usePartial ? "JR1, JR2, JR3" : "Full Level (1-6)";
                    else if (item.key === 'senior_part_1') subText = usePartial ? "SR1, SR2, SR3" : "Full Level (1-6)";
                    else if (item.key === 'senior_part_2') subText = usePartial ? "SR7, SR8, SR9" : "Full Level (7-12)";
                    
                    levelsInfo.push({ name: item.name, subLevels: subText });
                    
                    if (usePartial) {
                        totalClasses += str.partial_total;
                        totalMonths += str.partial_duration;
                        totalPrice += allPrices[region].masters[msKey][item.key].price_48;
                    } else {
                        totalClasses += str.total;
                        totalMonths += str.duration;
                        totalPrice += allPrices[region].masters[msKey][item.key].price_96;
                    }
                }
            } 
            return { totalClasses, totalMonths, totalPrice, levelNames, levelsInfo };
        }

        function getMultiLevelCardHTML(region, i, startLvlName, endLvlName, levelsList, classes, duration, price, discType, clsTypeLabel, clsTypeKey) {
            const id = `offer-stack-${i}-${region}`;
            return `
                <div class="offer-card" data-card-id="${id}" style="height: auto;">
                    <div class="offer-card-content">
                        <div class="flex items-center justify-center h-48 text-secondary">Loading Preview...</div>
                    </div>
                    <div class="mt-4">
                        <div class="flex w-full ss-actions-container">
                            <button onclick="copyCardForLaptop('${id}')" id="btn-copy-${id}" class="ss-action-btn btn-copy-pc">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy (PC)
                            </button>
                        </div>
                        <button onclick="showTerms()" class="text-xs text-accent mt-2 text-center block w-full hover:underline font-bold tracking-wider opacity-70 uppercase">* T&C applied</button>
                    </div>
                </div>
            `;
        }

        function renderFullOffers(region) {
            const container = document.getElementById(`offers-output-container-${region}`); 
            const rawFilter = document.getElementById(`upsell-filter-${region}`)?.value; 
            const currentClassType = document.querySelector(`input[name="class-type-global-${region}"]:checked`)?.value;
            
            if(!container || !rawFilter || !currentClassType) return;
            
            if(rawFilter === 'none') { 
                container.innerHTML = `<div class="col-span-1 md:col-span-2 text-center p-10 text-secondary italic border border-[var(--input-border)] rounded-xl bg-[rgba(125,125,125,0.05)]">Please select the student's <strong>Starting Level</strong> above to see offer stacks.</div>`; 
                return; 
            }
            
            const fdKey = currentClassType === 'one_on_one' ? 'one_on_one' : (region==='in'?'regular_group':'group'); 
            const msKey = currentClassType === 'one_on_one' ? 'one_on_one' : 'group';
            
            const isPartialCompleted = rawFilter.endsWith('_partial');
            const cleanKey = rawFilter.replace('_partial', '');
            
            let finishedIndex = -1;
            if (rawFilter !== 'all') {
                finishedIndex = fullLevelSequence.findIndex(item => item.key === cleanKey);
            }
            
            let startSequenceIndex = (rawFilter === 'all') ? 0 : finishedIndex;
            
            if (startSequenceIndex === -1 || startSequenceIndex >= fullLevelSequence.length) { 
                container.innerHTML = `<div class="col-span-2 text-center p-10 text-secondary italic">No further levels available.</div>`; 
                return; 
            }
            
            let html = '';
            let cardCounter = 0;
            for (let i = startSequenceIndex; i < fullLevelSequence.length; i++) {
                const currentItem = fullLevelSequence[i];
                
                if (currentItem.type === 'masters') {
                    const packageDataPartial = calculatePackageData(region, startSequenceIndex, i, fdKey, msKey, true);
                    const isSingleP = (startSequenceIndex === i);
                    html += getMultiLevelCardHTML(region, cardCounter++, fullLevelSequence[startSequenceIndex].name.toUpperCase(), currentItem.name.toUpperCase() + " (PARTIAL)", packageDataPartial.levelNames, packageDataPartial.totalClasses, packageDataPartial.totalMonths, packageDataPartial.totalPrice, isSingleP ? 'full_single' : 'full_bundle', currentClassType === 'one_on_one' ? 'ONE-ON-ONE' : 'GROUP', currentClassType);

                    const packageDataFull = calculatePackageData(region, startSequenceIndex, i, fdKey, msKey, false);
                    const isSingleF = (startSequenceIndex === i);
                    html += getMultiLevelCardHTML(region, cardCounter++, fullLevelSequence[startSequenceIndex].name.toUpperCase(), currentItem.name.toUpperCase(), packageDataFull.levelNames, packageDataFull.totalClasses, packageDataFull.totalMonths, packageDataFull.totalPrice, isSingleF ? 'full_single' : 'full_bundle', currentClassType === 'one_on_one' ? 'ONE-ON-ONE' : 'GROUP', currentClassType);
                } else {
                    const packageData = calculatePackageData(region, startSequenceIndex, i, fdKey, msKey, false); 
                    const isSingle = (startSequenceIndex === i);
                    html += getMultiLevelCardHTML(region, cardCounter++, fullLevelSequence[startSequenceIndex].name.toUpperCase(), currentItem.name.toUpperCase(), packageData.levelNames, packageData.totalClasses, packageData.totalMonths, packageData.totalPrice, isSingle ? 'full_single' : 'full_bundle', currentClassType === 'one_on_one' ? 'ONE-ON-ONE' : 'GROUP', currentClassType);
                }
            }
            
            container.innerHTML = html; 
            recalcFullOffers(region);
        }

        function recalcFullOffers(region) {
            const rawFilter = document.getElementById(`upsell-filter-${region}`)?.value; 
            const currentClassType = document.querySelector(`input[name="class-type-global-${region}"]:checked`)?.value;
            
            if(!rawFilter || rawFilter === 'none' || !currentClassType) return;
            
            const rs = getRegionState(region);
            const discSingle = getActiveDiscounts(region, 'full_single'); 
            const discBundle = getActiveDiscounts(region, 'full_bundle'); 
            const couponEnabled = document.getElementById(`coupon-enable-${region}`)?.checked;
            const coup = couponEnabled ? generateCoupon(document.getElementById(`coupon-type-display-full-${region}`)?.textContent || '') : null;
            const exp = couponEnabled ? formatExpiry(document.getElementById(`coupon-expiry-${region}`)?.value) : null;
            const benefits = rs.full.selected;
            
            const fdKey = currentClassType === 'one_on_one' ? 'one_on_one' : (region==='in'?'regular_group':'group'); 
            const msKey = currentClassType === 'one_on_one' ? 'one_on_one' : 'group';
            
            const isPartialCompleted = rawFilter.endsWith('_partial');
            const cleanKey = rawFilter.replace('_partial', '');
            let finishedIndex = -1;
            if (rawFilter !== 'all') {
                finishedIndex = fullLevelSequence.findIndex(item => item.key === cleanKey);
            }
            
            let startSequenceIndex = (rawFilter === 'all') ? 0 : finishedIndex;
            
            let cardCount = 0;
            for (let i = startSequenceIndex; i < fullLevelSequence.length; i++) {
                const currentItem = fullLevelSequence[i];
                const iterations = currentItem.type === 'masters' ? [true, false] : [false]; 
                
                iterations.forEach(forcePartial => {
                    const packageData = calculatePackageData(region, startSequenceIndex, i, fdKey, msKey, forcePartial);
                    const isSingle = (startSequenceIndex === i);
                    
                    const activeDisc = isSingle ? discSingle : discBundle;
                    
                    const nSave = Math.floor(packageData.totalPrice * (activeDisc.normal/100));
                    const mSave = Math.floor(packageData.totalPrice * (activeDisc.mgmt/100));
                    const rSave = activeDisc.referral;
                    
                    const finalPrice = packageData.totalPrice - nSave - mSave - rSave;
                    
                    const studentName = StudentNameController.getStudentName(region, 'full');
                    const showStudentName = StudentNameController.getShowStudentName(region, 'full');
                    
                    const id = `offer-stack-${cardCount}-${region}`;
                    const card = document.querySelector(`[data-card-id="${id}"] .offer-card-content`);
                    
                    if (card) {
                        let title = "";
                        if (fullLevelSequence[startSequenceIndex].name === currentItem.name) {
                             title = currentItem.name.toUpperCase() + (forcePartial ? " (PARTIAL)" : "");
                        } else {
                             title = `${fullLevelSequence[startSequenceIndex].name.toUpperCase()} - ${currentItem.name.toUpperCase()}${forcePartial ? " (PARTIAL)" : ""}`;
                        }
                        
                        const conversionData = { enabled: false, targetCurrency: '', rate: 1, symbol: '' };
                        if (rs.conversionEnabled[`${region}-full`] && rs.conversionShowInOutput[`${region}-full`] && globalConversionRates) {
                            const target = rs.conversionEnabled[`${region}-full`];
                            const baseCode = conversionCurrencies[region].code;
                            const rate = convertPrice(1, baseCode, target);
                            if(rate) {
                                conversionData.enabled = true;
                                conversionData.targetCurrency = target;
                                conversionData.rate = rate;
                                conversionData.symbol = conversionCurrencies[Object.keys(conversionCurrencies).find(key => conversionCurrencies[key].code === target)].symbol;
                            }
                        }

                        const newPreviewHTML = generateNewPreviewHTML({
                            region: region,
                            idPrefix: id,
                            studentName: studentName,
                            showStudentName: showStudentName,
                            classType: currentClassType,
                            levels: packageData.levelsInfo, 
                            totalSessions: packageData.totalClasses,
                            totalMonths: packageData.totalMonths, 
                            benefits: benefits,
                            priceDetails: {
                                fullPrice: packageData.totalPrice,
                                finalPrice: finalPrice,
                                discounts: {
                                    normal: activeDisc.normal,
                                    mgmt: activeDisc.mgmt,
                                    referral: activeDisc.referral,
                                    normalValue: nSave,
                                    mgmtValue: mSave,
                                    referralValue: rSave
                                }
                            },
                            currency: allPrices[region].currency,
                            couponCode: coup || '',
                            expiry: exp || '',
                            title: title,
                            levelCount: packageData.levelNames.length,
                            bannerSettings: {
                                showBanner: rs.bannerSettings.showBanner,
                                bannerText: isSingle ? rs.bannerSettings.bannerTextSingle : rs.bannerSettings.bannerTextBundle
                            },
                            showDiscountPercent: rs.showDiscountPercent,
                            priceLabelType: rs.priceLabelType,
                            showPPC: rs.showPPCInOutput[`${region}-full`],
                            conversion: conversionData,
                            referralSettings: rs.full.referralSettings 
                        });
                        
                        card.innerHTML = newPreviewHTML;
                    }
                    cardCount++;
                });
            }
            
            ConverterController.updatePreview(region, 'full');
        }

        function createPriceConverterHTML(region, idPrefix) {
            let opts = ''; Object.entries(conversionCurrencies).forEach(([key, info]) => opts += `<option value="${info.code}">${info.name} (${info.code})</option>`);
            return `<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">From</label><div class="flex items-center gap-2 p-2 rounded bg-gray-50 border border-gray-200">${regionNames[region]}</div></div>
                <div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">To</label><select id="conversion-target-${idPrefix}-${region}" class="input-premium" onchange="ConverterController.triggerUpdate('${region}', '${idPrefix}')">${opts}</select></div>
            </div>
            <div class="mt-4 flex items-center justify-between flex-wrap gap-3">
                <label class="flex items-center gap-2 cursor-pointer text-sm text-secondary">
                    <label class="toggle-switch"><input type="checkbox" id="conversion-show-${idPrefix}-${region}" onchange="ConverterController.triggerUpdate('${region}', '${idPrefix}')"><span class="toggle-slider"></span></label>
                    <span class="text-xs uppercase font-bold tracking-wide">Show in output</span>
                </label>
                <div class="flex items-center gap-2"><button type="button" id="refresh-rates-${idPrefix}-${region}" class="refresh-btn" onclick="refreshRates('${region}', '${idPrefix}')">${icons.refresh} Refresh</button></div>
            </div>
            <div id="conversion-preview-${idPrefix}-${region}" class="mt-4 p-4 rounded-lg hidden" style="background: var(--badge-lvl-bg); border: 1px solid var(--badge-lvl-bd);"><div class="text-[0.65rem] font-bold text-accent mb-2 uppercase tracking-widest">Preview Rate</div><div class="text-sm text-primary" id="conversion-preview-text-${idPrefix}-${region}"></div></div>`;
        }
        
        function createBenefitsManagerHTML(region, idPrefix) { return `<div class="grid grid-cols-1 md:grid-cols-2 gap-5"><div><h3 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide">Available</h3><div id="available-benefits-list-${idPrefix}-${region}" class="max-h-72 overflow-y-auto space-y-2 pr-2"></div><div class="mt-3"><label class="block text-xs font-bold text-accent mb-2 uppercase">Add Custom</label><div class="flex rounded-md shadow-sm"><input type="text" id="custom-benefit-input-${idPrefix}-${region}" class="input-premium rounded-r-none" placeholder="Enter..."><button type="button" onclick="addCustomBenefit('${region}', '${idPrefix}')" class="inline-flex items-center px-3 py-2 border-l border-t border-b border-r rounded-r-md bg-blue-900/20 text-xs font-bold uppercase text-accent hover:bg-blue-900/40" style="border-color:var(--input-border);">Add</button></div></div></div><div><h3 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide">Selected</h3><div id="selected-benefits-list-${idPrefix}-${region}" class="max-h-80 overflow-y-auto space-y-2 pr-2"></div></div></div>`; }
        
        function createDiscountInputBlock(region, idPrefix) {
            const lblOpts = discountLabels.map(l => `<div class="dropdown-item" onclick="selectDiscountLabel('${region}', '${idPrefix}', '${l}')">${l}</div>`).join('');
            return `<div class="discount-control"><label class="flex items-center space-x-2 cursor-pointer mb-3"><input type="checkbox" id="discount-enable-normal-${idPrefix}-${region}" class="h-4 w-4" onchange="handleDiscountChange('${region}', '${idPrefix}', 'normal')"><span class="block text-xs font-bold text-accent uppercase tracking-wider">Coupon Disc.</span></label><div class="relative"><input type="number" id="discount-input-normal-${idPrefix}-${region}" value="10" class="input-premium text-center text-base font-bold" oninput="handleDiscountChange('${region}', '${idPrefix}', 'normal')"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-base font-bold text-accent">%</span></div></div><div class="discount-control"><label class="flex items-center space-x-2 cursor-pointer mb-3"><input type="checkbox" id="discount-enable-mgmt-${idPrefix}-${region}" class="h-4 w-4" onchange="handleDiscountChange('${region}', '${idPrefix}', 'mgmt')"><div class="flex items-center gap-2 flex-grow relative"><span class="block text-xs font-bold uppercase tracking-wider" style="color:var(--add-save-color);" id="discount-label-display-${idPrefix}-${region}">Management Discount</span><button type="button" class="edit-btn" onclick="showDiscountLabelDropdown('${region}', '${idPrefix}')">Edit</button><div id="discount-label-dropdown-${idPrefix}-${region}" class="dropdown-menu hidden">${lblOpts}</div></div></label><div class="relative"><input type="number" id="discount-input-mgmt-${idPrefix}-${region}" value="0" class="input-premium text-center text-base font-bold" oninput="handleDiscountChange('${region}', '${idPrefix}', 'mgmt')"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-base font-bold" style="color:var(--add-save-color);">%</span></div></div><div class="discount-control"><label class="flex items-center space-x-2 cursor-pointer mb-3"><input type="checkbox" id="discount-enable-referral-${idPrefix}-${region}" class="h-4 w-4" onchange="handleDiscountChange('${region}', '${idPrefix}', 'referral')"><span class="block text-xs font-bold uppercase tracking-wider" style="color:var(--ref-save-color);">Referral Disc.</span></label><div class="relative"><input type="number" id="discount-input-referral-${idPrefix}-${region}" value="0" class="input-premium text-center text-base font-bold" oninput="handleDiscountChange('${region}', '${idPrefix}', 'referral')"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-base font-bold uppercase" style="color:var(--ref-save-color); font-size: 0.8rem;">${allPrices[region].currency}</span></div></div>`;
        }
        
        function getCurrentTotalClasses(region, idPrefix) {
            if (idPrefix === 'full') return classStructure.foundation_one_on_one.total;
            const cType = idPrefix, isFd = cType === 'foundation', clsType = document.querySelector(`input[name="class-type-${cType}-${region}"]:checked`)?.value;
            if (!clsType) return 1;
            const str = classStructure[`${cType}_${clsType}`] || classStructure.foundation_one_on_one;
            let total = 0; (isFd ? foundationLevels : mastersLevels).forEach(lvl => { for (let i = 1; i <= str.count; i++) { if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) total += str[`sub${i}`]; } });
            return total || 1;
        }

        function getCurrentFullPrice(region, idPrefix) {
            if (idPrefix === 'full') return 1000;
            const cType = idPrefix, isFd = cType === 'foundation', clsType = document.querySelector(`input[name="class-type-${cType}-${region}"]:checked`)?.value;
            if (!clsType) return 1000;
            const str = classStructure[`${cType}_${clsType}`], pData = allPrices[region][cType][clsType];
            if (!str || !pData) return 1000;
            let price = 0;
            (isFd ? foundationLevels : mastersLevels).forEach(lvl => {
                let lvlSubs = 0; for (let i = 1; i <= str.count; i++) if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) lvlSubs++;
                if (lvlSubs > 0) {
                    if (isFd) {
                        const base = Math.floor(pData[lvl] / str.count), rem = pData[lvl] % str.count;
                        for(let i=1; i<=str.count; i++) if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) price += base + (i === str.count ? rem : 0);
                    } else {
                        if(lvlSubs === str.count) price += pData[lvl].price_96; 
                        else {
                            const base = Math.floor(pData[lvl].price_48 / 3); 
                            const rem = pData[lvl].price_48 % 3;
                            for(let i=1; i<=str.count; i++) if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) price += base + ((i-1)%3 === 2 ? rem : 0);
                        }
                    }
                }
            });
            return price || 1;
        }

        function toggleSubLevelGroup(region, cType, lvl) {
            const inputs = document.querySelectorAll(`[id^="chk-${region}-${cType}-${lvl}-sub"]`); if(inputs.length === 0) return;
            const allChecked = Array.from(inputs).every(i => i.checked); inputs.forEach(i => i.checked = !allChecked); calculateCustomPackage(region, cType);
        }

        function generateCustomCalc(region, cType, gn1, gn2) {
            const isFd = cType === 'foundation', isInd = region === 'in', levels = isFd ? foundationLevels : mastersLevels, lNames = isFd ? foundationLevelNames : mastersLevelNames;
            let opts = `<label class="custom-type-btn"><input type="radio" name="class-type-${cType}-${region}" value="one_on_one" class="hidden" onchange="populateBenefits('${region}','${cType}');calculateCustomPackage('${region}','${cType}');" checked><span class="font-bold text-xs uppercase tracking-wider">  One-on-One</span></label><label class="custom-type-btn"><input type="radio" name="class-type-${cType}-${region}" value="${isInd&&isFd?'regular_group':'group'}" class="hidden" onchange="populateBenefits('${region}','${cType}');calculateCustomPackage('${region}','${cType}');"><span class="font-bold text-xs uppercase tracking-wider">  ${gn1}</span></label>${isInd&&isFd ? `<label class="custom-type-btn"><input type="radio" name="class-type-${cType}-${region}" value="focused_group" class="hidden" onchange="populateBenefits('${region}','${cType}');calculateCustomPackage('${region}','${cType}');"><span class="font-bold text-xs uppercase tracking-wider">  ${gn2}</span></label>` : ''}`;
            let checks = ''; levels.forEach(l => { const str = isFd?classStructure.foundation_group:classStructure.masters_group; checks += `<div class="mb-5"><h4 class="text-[0.65rem] font-bold text-accent uppercase mb-3 tracking-widest clickable-header" onclick="toggleSubLevelGroup('${region}', '${cType}', '${l}')" title="Click to Select All/None">${lNames[l]}</h4><div class="sub-lvl-grid">`; for(let i=1; i<=str.count; i++) { const dNum = (!isFd && l==='senior_part_2') ? i+6 : ((isFd && l==='adv_part_2') ? i+3 : i); checks += `<label class="sub-lvl-btn"><input type="checkbox" id="chk-${region}-${cType}-${l}-sub${i}" class="hidden" onchange="calculateCustomPackage('${region}','${cType}')"><span class="sub-lvl-code">${getSubLevelCode(l, dNum)}</span><svg class="sub-lvl-tick" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg></label>`; } checks += `</div></div>`; }); const cOpts = couponTypes.map(t => `<div class="dropdown-item" onclick="selectCouponType('${region}', '${cType}', '${t}')">${t}</div>`).join('');
            
            const typeAndLevelsContent = `
                <div class="mb-6">
                    <h3 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide">1. Type</h3>
                    <div class="flex flex-col gap-3 mb-6">${opts}</div>
                    
                    <h3 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide">2. Student Details</h3>
                    ${StudentNameController.renderControls(region, cType)}
                    
                    <h3 class="text-sm font-bold text-primary mt-6 mb-3 uppercase tracking-wide">3. Sub-Levels</h3>
                    <div id="sub-level-container-${cType}-${region}">${checks}</div>
                </div>`;
            
            const financialSuiteContent = createFinancialSuiteHTML(region, cType);
            
            const rs = getRegionState(region);
            const bannerChecked = rs.bannerSettings.showBanner ? 'checked' : '';

            const visualsContent = `
                <div class="flex items-center justify-between mb-4 flex-wrap gap-3">
                    <label class="flex items-center gap-2 cursor-pointer"><span class="text-xs font-bold text-accent uppercase">Show Discount %</span><label class="toggle-switch"><input type="checkbox" id="discount-percent-toggle-${region}" onchange="handleDiscountPercentToggle('${region}')"><span class="toggle-slider"></span></label></label>
                    <label class="flex items-center gap-2 cursor-pointer"><span class="text-xs font-bold text-accent uppercase">Label: Your Price</span><label class="toggle-switch"><input type="checkbox" id="price-label-toggle-${region}" onchange="togglePriceLabel('${region}', this)"><span class="toggle-slider"></span></label></label>
                </div>
                
                <div class="border-t border-[var(--header-border)] pt-4 mt-4">
                    <div class="flex items-center justify-between mb-3"><label class="block text-xs font-bold text-accent uppercase">Enable Coupon Code</label><label class="toggle-switch"><input type="checkbox" id="custom-coupon-enable-${cType}-${region}" onchange="calculateCustomPackage('${region}','${cType}')"><span class="toggle-slider"></span></label></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                        <div class="discount-control relative"><label class="block text-xs font-bold text-accent mb-2 uppercase">Coupon Type</label><div class="flex items-center gap-2"><button type="button" onclick="showCouponTypeDropdown('${region}', '${cType}')" class="input-premium flex items-center justify-between cursor-pointer"><span id="coupon-type-display-${cType}-${region}">LOYALTY</span><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/></svg></button></div><div id="coupon-type-dropdown-${cType}-${region}" class="dropdown-menu hidden">${cOpts}</div></div>
                        <div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">Expiry</label><input type="datetime-local" id="custom-coupon-expiry-${cType}-${region}" value="${getDefaultExpiry()}" class="input-premium"></div>
                    </div>
                </div>

                <div class="mt-4 border-t border-[var(--header-border)] pt-4 mb-6">
                    <div class="flex items-center justify-between mb-3"><span class="text-xs font-bold text-accent uppercase">Urgency Banner</span><label class="toggle-switch"><input type="checkbox" id="banner-toggle-${cType}-${region}" ${bannerChecked} onchange="handleBannerChange('${region}', 'toggle', '', '${cType}')"><span class="toggle-slider"></span></label></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="discount-control col-span-2"><label class="block text-[0.65rem] font-bold text-secondary mb-1 uppercase">Banner Text</label><input type="text" class="input-premium text-sm" value="Max Savings!" oninput="handleBannerChange('${region}', 'bundle', this.value, '${cType}')"></div>
                    </div>
                </div>
                
                <div class="mt-4 border-t border-[var(--header-border)] pt-4">
                    <h3 class="text-xs font-bold text-accent mb-4 uppercase tracking-wider">Benefits Manager</h3>
                    ${createBenefitsManagerHTML(region, cType)}
                </div>`;
            
            const previewId = `custom-${cType}-${region}`;
            const studentName = StudentNameController.getStudentName(region, cType);
            const showStudentName = StudentNameController.getShowStudentName(region, cType);
            
            let stateKey = 'full';
            if(cType === 'foundation') stateKey = 'customFd';
            if(cType === 'masters') stateKey = 'customMs';
            const initialRefSettings = rs[stateKey].referralSettings;

            const initialPreviewHTML = generateNewPreviewHTML({
                region: region,
                idPrefix: previewId,
                studentName: studentName,
                showStudentName: showStudentName,
                classType: 'one_on_one',
                levels: [],
                totalSessions: 0,
                benefits: [],
                priceDetails: {
                    fullPrice: 0,
                    finalPrice: 0,
                    discounts: { normal: 0, mgmt: 0, referral: 0 }
                },
                currency: allPrices[region].currency,
                couponCode: '',
                expiry: '',
                title: 'SELECT LEVELS',
                levelCount: 0,
                referralSettings: initialRefSettings 
            });
            
            return `
                <div class="premium-card">
                    <h2 class="section-title">🏗️ Builder</h2>
                    
                    ${wrapCollapsible('⚙️ Configuration', `col-config-${cType}-${region}`, typeAndLevelsContent, true)}
                    
                    ${wrapCollapsible('💰 Financial Suite', `col-financial-${cType}-${region}`, financialSuiteContent, true)}

                    ${wrapCollapsible('🎨 Visuals & Benefits', `col-visuals-${cType}-${region}`, visualsContent)}
                    
                    <div class="mt-6"><h3 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide">Review</h3>
                    <div class="offer-card" data-card-id="${previewId}" style="height: auto;">
                        <div class="offer-card-content">${initialPreviewHTML}</div>
                        <div class="p-4 border-t border-[var(--card-border)]">
                            <div class="flex w-full ss-actions-container">
                                <button onclick="copyCardForLaptop('${previewId}')" id="btn-copy-${previewId}" class="ss-action-btn btn-copy-pc"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy (PC)</button>
                            </div>
                            <button onclick="showTerms()" class="text-xs text-accent mt-2 text-center block w-full hover:underline font-bold tracking-wider opacity-70 uppercase">* T&C applied</button>
                        </div>
                    </div>
                    </div>
                </div>`;
        }
        
        function calculateCustomPackage(region, cType) {
            const isFd = cType === 'foundation', clsType = document.querySelector(`input[name="class-type-${cType}-${region}"]:checked`)?.value; if(!clsType) return;
            const str = classStructure[`${cType}_${clsType}`], pData = allPrices[region][cType][clsType], levels = isFd ? foundationLevels : mastersLevels, lNames = isFd ? foundationLevelNames : mastersLevelNames;
            let totalClasses = 0, totalDuration = 0, fullPrice = 0, subCostHTML = '', firstSelected = null, lastSelected = null, includedList = [], selectedCount = 0;

            const discounts = getActiveDiscounts(region, cType);
            const totalDiscPercent = discounts.normal + discounts.mgmt;

            levels.forEach(lvl => {
                let lvlSubs = 0, lvlClasses = 0;
                for(let i=1; i<=str.count; i++) { if(document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) { lvlSubs++; lvlClasses += str[`sub${i}`]; } }
                if(lvlSubs > 0) {
                    if(!firstSelected) firstSelected = lNames[lvl];
                    lastSelected = lNames[lvl]; selectedCount++;
                    
                    let subLevelsSelected = [];
                    for(let i=1; i<=str.count; i++) if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) subLevelsSelected.push(i);
                    
                    let subText = '';
                    const dNum = (!isFd && lvl==='senior_part_2') ? subLevelsSelected[0]+6 : ((isFd && lvl==='adv_part_2') ? subLevelsSelected[0]+3 : subLevelsSelected[0]);
                    
                    const isAdvOverride = (lvl === 'adv_part_1' || lvl === 'adv_part_2') && subLevelsSelected.length === str.count;

                    if (subLevelsSelected.length === str.count && !isAdvOverride) subText = 'Full Level';
                    else if (subLevelsSelected.length === 1 && !isAdvOverride) subText = getSubLevelCode(lvl, dNum);
                    else {
                        const codes = subLevelsSelected.map(idx => getSubLevelCode(lvl, (!isFd && lvl==='senior_part_2') ? idx+6 : ((isFd && lvl==='adv_part_2') ? idx+3 : idx)));
                        subText = codes.join(', ');
                    }

                    includedList.push({
                        name: lNames[lvl],
                        subLevels: subText
                    });
                    
                    totalClasses += lvlClasses; 
                    let cost = 0;
                    if (isFd) {
                        const base = Math.floor(pData[lvl] / str.count), rem = pData[lvl] % str.count;
                        for(let i=1; i<=str.count; i++) if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) cost += base + (i === str.count ? rem : 0);
                    } else {
                        if(lvlSubs === str.count) cost = pData[lvl].price_96; 
                        else {
                            const base = Math.floor(pData[lvl].price_48 / 3);
                            const rem = pData[lvl].price_48 % 3;
                            for(let i=1; i<=str.count; i++) {
                                if (document.getElementById(`chk-${region}-${cType}-${lvl}-sub${i}`)?.checked) {
                                    cost += base + ((i - 1) % 3 === 2 ? rem : 0);
                                }
                            }
                        }
                    }
                    fullPrice += cost; 
                    let dur = (str.duration/str.count)*lvlSubs; totalDuration += dur;

                    const discountAmt = Math.floor(cost * (totalDiscPercent / 100));
                    const finalRowCost = cost - discountAmt;

                    subCostHTML += `
                        <div class="grid grid-cols-3 text-xs mb-1 gap-1 items-center border-b border-[rgba(255,255,255,0.05)] pb-1 last:border-none">
                            <div class="col-span-1 text-left font-semibold text-primary break-words">${lNames[lvl]}</div>
                            <div class="col-span-1 text-right text-[10px] text-secondary line-through">${formatCurrency(cost, allPrices[region].currency)}</div>
                            <div class="col-span-1 text-right font-bold text-accent">${formatCurrency(finalRowCost, allPrices[region].currency)}</div>
                        </div>`;
                }
            });

            const nSave = Math.floor(fullPrice * (discounts.normal/100));
            const mSave = Math.floor(fullPrice * (discounts.mgmt/100));
            const rSave = discounts.referral;
            
            const finalPrice = fullPrice - nSave - mSave - rSave;

            if (subCostHTML) {
                subCostHTML += `
                    <div class="grid grid-cols-3 text-xs mt-2 pt-2 border-t border-[rgba(255,255,255,0.2)] gap-1 items-center">
                        <div class="col-span-1 text-left font-black text-primary uppercase">Total</div>
                        <div class="col-span-2 text-right font-black text-lg text-accent">${formatCurrency(finalPrice, allPrices[region].currency)}</div>
                    </div>
                `;
            }
            
            const showRoadmap = document.getElementById(`roadmap-show-toggle-${cType}-${region}`)?.checked || false;
            
            const rs = getRegionState(region);
            const rCount = rs.roadmapData ? (rs.roadmapData.count || 3) : 3;
            
            const roadmapRows = [];
            for(let i=1; i<=rCount; i++) {
                const label = document.getElementById(`roadmap-label-${i}-${cType}-${region}`)?.value || '';
                const dateRaw = document.getElementById(`roadmap-date-${i}-${cType}-${region}`)?.value || '';
                const date = formatRoadmapDate(dateRaw);
                const percent = parseFloat(document.getElementById(`roadmap-percent-${i}-${cType}-${region}`)?.value) || 0;
                roadmapRows.push({ label, date, percent });
            }

            let displayTitle = "SELECT LEVELS";
            if (firstSelected) {
                displayTitle = firstSelected === lastSelected ? firstSelected.toUpperCase() : `${firstSelected.toUpperCase()} - ${lastSelected.toUpperCase()}`;
            }
            
            PPCController.updateDisplay(region, cType, finalPrice, totalClasses);
            
            const benefits = rs[cType==='foundation'?'customFd':'customMs'].selected;
            const couponToggle = document.getElementById(`custom-coupon-enable-${cType}-${region}`);
            const coup = (couponToggle && couponToggle.checked) ? generateCoupon(document.getElementById(`coupon-type-display-${cType}-${region}`).textContent) : null; 
            const exp = (couponToggle && couponToggle.checked) ? formatExpiry(document.getElementById(`custom-coupon-expiry-${cType}-${region}`).value) : null;
            
            const studentName = StudentNameController.getStudentName(region, cType);
            const showStudentName = StudentNameController.getShowStudentName(region, cType);
            
            const conversionData = { enabled: false, targetCurrency: '', rate: 1, symbol: '' };
            if (rs.conversionEnabled[`${region}-${cType}`] && rs.conversionShowInOutput[`${region}-${cType}`] && globalConversionRates) {
                const target = rs.conversionEnabled[`${region}-${cType}`];
                const baseCode = conversionCurrencies[region].code;
                const rate = convertPrice(1, baseCode, target);
                if(rate) {
                    conversionData.enabled = true;
                    conversionData.targetCurrency = target;
                    conversionData.rate = rate;
                    conversionData.symbol = conversionCurrencies[Object.keys(conversionCurrencies).find(key => conversionCurrencies[key].code === target)].symbol;
                }
            }

            const refStateKey = cType === 'foundation' ? 'customFd' : 'customMs';
            const currentRefSettings = rs[refStateKey].referralSettings;

            const previewId = `custom-${cType}-${region}`;
            const previewContainer = document.querySelector(`[data-card-id="${previewId}"] .offer-card-content`);
            if (previewContainer) {
                const newPreviewHTML = generateNewPreviewHTML({
                    region: region,
                    idPrefix: previewId,
                    studentName: studentName,
                    showStudentName: showStudentName,
                    classType: clsType,
                    levels: includedList,
                    totalSessions: totalClasses,
                    totalMonths: Math.round(totalDuration * 10) / 10, 
                    benefits: benefits,
                    priceDetails: {
                        fullPrice: fullPrice,
                        finalPrice: finalPrice,
                        discounts: {
                            normal: discounts.normal,
                            mgmt: discounts.mgmt,
                            referral: discounts.referral, 
                            normalValue: nSave,
                            mgmtValue: mSave,
                            referralValue: rSave
                        }
                    },
                    currency: allPrices[region].currency,
                    couponCode: coup || '',
                    expiry: exp || '',
                    title: displayTitle,
                    levelCount: selectedCount,
                    bannerSettings: {
                        showBanner: rs.bannerSettings.showBanner,
                        bannerText: rs.bannerSettings.bannerTextBundle
                    },
                    showDiscountPercent: rs.showDiscountPercent,
                    priceLabelType: rs.priceLabelType,
                    showPPC: rs.showPPCInOutput[`${region}-${cType}`],
                    conversion: conversionData,
                    referralSettings: currentRefSettings, 
                    roadmapSettings: { show: showRoadmap, rows: roadmapRows } 
                });
                
                previewContainer.innerHTML = newPreviewHTML;
            }
            
            const psl = document.getElementById(`psl-display-${cType}-${region}`); if(psl) psl.innerHTML = subCostHTML || '<span class="text-xs text-secondary italic">Select levels</span>';
            
            ConverterController.updatePreview(region, cType, finalPrice);
        }

        function generateAutoPricerHTML(currentRegion) {
            const r = apGlobalState.targetRegion, is1on1 = apGlobalState.classType === 'one_on_one', isGroup = apGlobalState.classType === 'group', isB3 = apGlobalState.bundleMode === '3', isB6 = apGlobalState.bundleMode === '6', isBCustom = apGlobalState.bundleMode === 'custom';
            const countryGrid = Object.keys(regionNames).map(code => {
                const cleanName = regionNames[code]; 
                return `<button onclick="updateAPState('targetRegion', '${code}')" class="flex-grow min-w-[30%] px-3 py-3 rounded-xl border flex items-center justify-center gap-2 ${code===r?'border-orange-600 bg-orange-600 text-white shadow-md':'border-[var(--input-border)] bg-[#fff7ed] hover:border-orange-300 text-secondary'} font-bold text-[0.65rem] uppercase hover:border-[var(--accent)] transition-all">${cleanName}</button>`;
            }).join('');
            
            const studentName = StudentNameController.getStudentName(currentRegion, 'autoPricer');
            const showStudentName = StudentNameController.getShowStudentName(currentRegion, 'autoPricer');
            const isParent = apGlobalState.oppMode === 'parent';

            const priceData = calculateAutoPricerPrices();
            const finalAmount = priceData.finalPrice;
            const formattedAmount = finalAmount.toLocaleString('en-US'); 
            const currencyISOCode = conversionCurrencies[apGlobalState.targetRegion].code; 
            
            const defRef = referralDefaults[currentRegion] || 20;
            const currentRef = apGlobalState.referralAmount || defRef;

            const generatedSKUs = generateCurriculumStrings();
            const skuListHTML = generatedSKUs.length > 0 ? 
                `<div class="mt-2 space-y-2">
                    ${generatedSKUs.map(sku => `
                        <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200 text-xs hover:border-orange-300 transition-all">
                            <span class="font-mono font-bold text-gray-700 select-all truncate mr-2">${sku}</span>
                            <button onclick="copyHelperAmount('${sku}', this)" class="shrink-0 flex items-center gap-1 text-[10px] bg-white border border-gray-300 px-2 py-1 rounded hover:bg-orange-50 hover:text-orange-600 hover:border-orange-200 transition uppercase font-bold">
                                <span>Copy</span>
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                            </button>
                        </div>
                    `).join('')}
                </div>` 
                : '<div class="text-[10px] text-gray-400 italic mt-2">No curriculum parsed.</div>';

            return `<div class="premium-card" id="ap-container-wrapper">
                <div class="max-w-lg mx-auto">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 rounded-full border border-[var(--accent)] flex items-center justify-center text-2xl bg-orange-100 text-orange-600 shadow-md">🤖</div>
                        <div><h2 class="text-2xl font-black text-primary uppercase">Opportunity Helper</h2><p class="text-[0.65rem] text-accent font-bold tracking-widest uppercase">Intelligent Auto-Pricer</p></div>
                    </div>
                    
                    ${StudentNameController.renderControls(currentRegion, 'autoPricer')}
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-xs font-bold text-accent uppercase">1. Paste CRM String</label>
                            <div class="flex bg-gray-100 rounded-lg p-1 gap-1 border border-gray-200">
                                <button onclick="updateAPState('oppMode', 'parent')" class="${isParent ? 'bg-white shadow text-accent border border-orange-200' : 'text-gray-400 hover:text-gray-600'} text-[10px] font-extrabold px-3 py-1 rounded transition-all uppercase tracking-wide">🔮 Predict Next</button>
                                <button onclick="updateAPState('oppMode', 'current')" class="${!isParent ? 'bg-white shadow text-accent border border-orange-200' : 'text-gray-400 hover:text-gray-600'} text-[10px] font-extrabold px-3 py-1 rounded transition-all uppercase tracking-wide">🎯 Current Only</button>
                            </div>
                        </div>
                        <textarea id="ap-global-input" rows="3" class="input-premium font-mono text-sm" placeholder="e.g. NRNOV24 Viraaj Sharma A1-A3" oninput="updateAPState('rawInput', this.value)">${apGlobalState.rawInput}</textarea>
                        <div id="ap-global-error" class="text-red-500 text-xs mt-2 font-bold hidden"></div>
                    </div>

                    <div id="ap-global-controls" class="${apGlobalState.isParsed ? '' : 'hidden'} animate-[fadeIn_0.5s_ease]">
                        <div class="mb-4 p-4 rounded-xl border border-[var(--input-border)] bg-[rgba(125,125,125,0.02)]">
                            <label class="block text-xs font-bold text-accent mb-3 uppercase">2. Select Country</label>
                            <div class="flex flex-wrap gap-2 justify-between">${countryGrid}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div><label class="block text-xs font-bold text-accent mb-2 uppercase">3. Class Type</label><div class="flex flex-col gap-2"><button onclick="updateAPState('classType', 'one_on_one')" class="custom-type-btn py-3 ${is1on1 ? 'border-[var(--accent)] bg-[var(--badge-lvl-bg)] text-[var(--accent)]' : ''}"><span class="font-bold text-xs uppercase">  1-on-1</span></button><button onclick="updateAPState('classType', 'group')" class="custom-type-btn py-3 ${isGroup ? 'border-[var(--accent)] bg-[var(--badge-lvl-bg)] text-[var(--accent)]' : ''}"><span class="font-bold text-xs uppercase">  Group</span></button></div></div>
                            <div><label class="block text-xs font-bold text-accent mb-2 uppercase">4. Bundle</label><div class="flex flex-col gap-2"><button onclick="updateAPState('bundleMode', '3')" class="custom-type-btn py-3 ${isB3 ? 'border-[var(--accent)] bg-[var(--badge-lvl-bg)] text-[var(--accent)]' : ''}"><span class="font-bold text-xs uppercase">  Next 3</span></button><button onclick="updateAPState('bundleMode', '6')" class="custom-type-btn py-3 ${isB6 ? 'border-[var(--accent)] bg-[var(--badge-lvl-bg)] text-[var(--accent)]' : ''}"><span class="font-bold text-xs uppercase">  Next 6</span></button><div class="flex gap-2"><button onclick="updateAPState('bundleMode', 'custom')" class="custom-type-btn py-3 flex-grow ${isBCustom ? 'border-[var(--accent)] bg-[var(--badge-lvl-bg)] text-[var(--accent)]' : ''}"><span class="font-bold text-xs uppercase">  Cust.</span></button><input type="number" min="1" max="20" value="${apGlobalState.customCount}" oninput="updateAPState('customCount', this.value)" class="input-premium w-14 text-center font-bold px-1" title="Extend Range"></div></div></div>
                        </div>
                        
                        <div class="mb-4 bg-[rgba(125,125,125,0.05)] rounded-lg p-3 border border-[var(--input-border)] flex items-center gap-4">
                            <div class="flex items-center gap-2 min-w-[100px]">
                                <span class="text-[0.65rem] font-bold text-secondary uppercase">Referral</span>
                                <label class="toggle-switch small"><input type="checkbox" ${apGlobalState.referralEnabled ? 'checked' : ''} onchange="updateAPState('referralEnabled', this.checked)"><span class="toggle-slider"></span></label>
                            </div>
                            <input type="text" value="${currentRef}" class="fs-light-input bg-white" style="font-size:0.8rem;" placeholder="Ref Amount" oninput="updateAPState('referralAmount', this.value)" ${!apGlobalState.referralEnabled ? 'disabled style="opacity:0.5;"' : ''}>
                        </div>

                        <div class="mb-4"><h3 class="text-sm font-bold text-primary mb-3 uppercase tracking-wide">5. Generated Receipt</h3>
                            
                            <div class="mb-5 bg-white border border-gray-200 rounded-xl p-4 shadow-sm relative overflow-hidden group hover:border-orange-300 transition-all">
                                <div class="absolute top-0 left-0 w-1 h-full bg-orange-500"></div>
                                <div class="flex items-center justify-between gap-3 border-b border-gray-100 pb-3 mb-3">
                                    <div>
                                        <p class="text-[0.65rem] uppercase font-bold text-gray-400 tracking-widest mb-0.5">Total Amount (${currencyISOCode})</p>
                                        <div class="flex items-baseline gap-1">
                                            <span class="text-3xl font-black text-gray-800 tracking-tight">${formattedAmount}</span>
                                        </div>
                                    </div>
                                    <button onclick="copyHelperAmount('${formattedAmount}', this)" class="flex items-center gap-2 px-3 py-1.5 bg-gray-50 hover:bg-orange-50 border border-gray-200 hover:border-orange-200 rounded-lg transition-all">
                                        <span class="text-[0.65rem] font-bold text-gray-600 hover:text-orange-600 uppercase">Copy Amount</span>
                                        <svg class="w-3 h-3 text-gray-400 hover:text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </button>
                                </div>
                                
                                <div>
                                    <p class="text-[0.65rem] uppercase font-bold text-gray-400 tracking-widest mb-1">Curriculum Name</p>
                                    ${skuListHTML}
                                </div>
                            </div>

                            <div class="offer-card" data-card-id="ap-receipt-card" style="height: auto;">
                                <div class="offer-card-content">
                                    ${generateNewPreviewHTML({
                                        region: apGlobalState.targetRegion,
                                        idPrefix: 'ap-receipt-card',
                                        studentName: studentName,
                                        showStudentName: showStudentName,
                                        classType: apGlobalState.classType,
                                        levels: calculateAutoPricerLevels(),
                                        totalSessions: calculateAutoPricerSessions(),
                                        totalMonths: calculateAutoPricerDuration(),
                                        benefits: benefitsData.default,
                                        priceDetails: priceData,
                                        currency: allPrices[apGlobalState.targetRegion].currency,
                                        couponCode: '',
                                        expiry: `Valid till: ${new Date().toLocaleDateString()}`,
                                        title: 'CURRICULUM NAME',
                                        levelCount: calculateAutoPricerLevels().length,
                                        referralSettings: { show: true, amount: currentRef }
                                    })}
                                </div>
                                <div class="p-4 border-t border-[var(--card-border)]">
                                    <div class="flex w-full ss-actions-container"><button onclick="copyCardForLaptop('ap-receipt-card')" id="btn-copy-ap-receipt-card" class="ss-action-btn btn-copy-pc"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy (PC)</button></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function calculateAutoPricerLevels() {
            if (!apGlobalState.isParsed) return [];
            
            const allMatches = [...apGlobalState.rawInput.matchAll(/\b([A-Z]+)(\d+)\b/g)];
            const validIndices = [];
            
            allMatches.forEach(m => {
                const code = m[1] + m[2];
                const idx = globalLevelSequence.findIndex(item => item.code === code);
                if (idx !== -1) validIndices.push(idx);
            });
            
            if (validIndices.length === 0) return [];
            
            const firstIdx = validIndices[0];
            const lastIdx = validIndices[validIndices.length - 1];
            
            let rawLevels = [];
            const isCurrent = apGlobalState.oppMode === 'current';
            const start = isCurrent ? firstIdx : lastIdx + 1;
            
            let limit = 0;
            if(isCurrent) {
                if(apGlobalState.bundleMode === 'custom') {
                   limit = parseInt(apGlobalState.customCount);
                } else {
                   limit = (lastIdx - firstIdx + 1);
                }
            } else {
                limit = apGlobalState.bundleMode === '3' ? 3 : (apGlobalState.bundleMode === '6' ? 6 : parseInt(apGlobalState.customCount));
            }

            for(let i=0; i<limit; i++) {
                const idx = start + i;
                if(idx >= globalLevelSequence.length) break;
                const item = globalLevelSequence[idx];
                
                let mainName = foundationLevelNames[item.levelKey] || mastersLevelNames[item.levelKey];
                if(item.levelKey === 'senior_part_1') mainName = 'Senior Part 1';
                else if(item.levelKey === 'senior_part_2') mainName = 'Senior Part 2';
                else if(item.levelKey === 'adv_part_1') mainName = 'Advanced Part 1';
                else if(item.levelKey === 'adv_part_2') mainName = 'Advanced Part 2';
                else if(item.levelKey === 'adv_beginner') mainName = 'Advanced Beginner';
                else if(item.levelKey === 'sub_junior') mainName = 'Sub-Junior';
                
                rawLevels.push({ mainName: mainName, subIndex: item.subIndex, levelKey: item.levelKey });
            }
            
            const grouped = [];
            let currentGroup = null;

            rawLevels.forEach(lvl => {
                if (currentGroup && currentGroup.name === lvl.mainName) {
                    currentGroup.subs.push({idx: lvl.subIndex, key: lvl.levelKey});
                } else {
                    if (currentGroup) grouped.push(currentGroup);
                    currentGroup = { name: lvl.mainName, subs: [{idx: lvl.subIndex, key: lvl.levelKey}] };
                }
            });
            if (currentGroup) grouped.push(currentGroup);

            return grouped.map(g => {
                const codes = g.subs.map(s => {
                    const isFd = foundationLevels.includes(s.key);
                    const dNum = (!isFd && s.key==='senior_part_2') ? s.idx+6 : ((isFd && s.key==='adv_part_2') ? s.idx+3 : s.idx);
                    return getSubLevelCode(s.key, dNum);
                });
                
                return {
                    name: g.name,
                    subLevels: codes.join(", "),
                    key: g.subs[0].key,
                    count: g.subs.length
                };
            });
        }
        
        function generateCurriculumStrings() {
            if (!apGlobalState.isParsed) return [];
            
            const region = apGlobalState.targetRegion;
            const classType = apGlobalState.classType; 
            const levels = calculateAutoPricerLevels(); 
            
            let regionPrefix = (regionCodeMap[region] || 'WW');
            if(region === 'uae') regionPrefix = 'UAE';
            if(region === 'in') regionPrefix = 'IND';
            if(region === 'sgd') regionPrefix = 'SIN';
            if(region === 'usa') regionPrefix = 'USA';
            if(region === 'uk') regionPrefix = 'UK';
            if(region === 'aus') regionPrefix = 'AUS';
            
            const flatKeys = [];
            levels.forEach(l => {
                flatKeys.push({ key: l.key, isFull: l.count >= (foundationLevels.includes(l.key) ? 3 : 6) });
            });

            const bundles = [];
            let i = 0;
            while(i < flatKeys.length) {
                const current = flatKeys[i];
                let matched = false;

                if (i + 3 < flatKeys.length) {
                    if (current.key === 'sub_junior' && flatKeys[i+1].key === 'junior' && flatKeys[i+2].key === 'senior_part_1' && flatKeys[i+3].key === 'senior_part_2') {
                        if(current.isFull && flatKeys[i+1].isFull && flatKeys[i+2].isFull && flatKeys[i+3].isFull) {
                            bundles.push({ name: 'Master', isPartial: false });
                            i += 4; matched = true; continue;
                        }
                    }
                }

                if (i + 4 < flatKeys.length) {
                    const keys = flatKeys.slice(i, i+5).map(k => k.key);
                    if (JSON.stringify(keys) === JSON.stringify(['beginner', 'adv_beginner', 'intermediate', 'adv_part_1', 'adv_part_2'])) {
                         if(flatKeys.slice(i, i+5).every(k => k.isFull)) {
                            bundles.push({ name: 'Foundation', isPartial: false });
                            i += 5; matched = true; continue;
                         }
                    }
                }

                if (i + 2 < flatKeys.length) {
                    const keys = flatKeys.slice(i, i+3).map(k => k.key);
                    if (JSON.stringify(keys) === JSON.stringify(['beginner', 'adv_beginner', 'intermediate'])) {
                        if(flatKeys.slice(i, i+3).every(k => k.isFull)) {
                            bundles.push({ name: 'Building Blocks', isPartial: false });
                            i += 3; matched = true; continue;
                        }
                    }
                }

                if (i + 1 < flatKeys.length) {
                    if (current.key === 'adv_part_1' && flatKeys[i+1].key === 'adv_part_2') {
                        if(current.isFull && flatKeys[i+1].isFull) {
                            bundles.push({ name: 'Advanced Stratagems', isPartial: false });
                            i += 2; matched = true; continue;
                        }
                    }
                }

                if (!matched) {
                    let name = levels[i].name; 
                    if(name === 'Sub-Junior') name = 'Sub_Junior'; 
                    bundles.push({ name: name, isPartial: !current.isFull });
                    i++;
                }
            }

            const skus = bundles.map(b => {
                const nameLower = b.name.toLowerCase();
                const isMasters = nameLower.includes('junior') || nameLower.includes('senior') || nameLower.includes('master');
                const isFoundation = !isMasters;
                
                let infix = '';
                if (isFoundation) {
                    if (classType === 'one_on_one') infix = 'nFPI_'; 
                    else {
                        if (region === 'in') infix = 'nRegular_'; 
                        else infix = 'nFocused_'; 
                    }
                } else {
                    if (classType === 'one_on_one') infix = 'nMPI_'; 
                    else {
                        if (region === 'in') infix = 'nPTP_'; 
                        else infix = 'nBTP_'; 
                    }
                }
                
                let finalName = b.name;
                if (b.isPartial) finalName += '_Partial';
                
                return regionPrefix + '_' + infix + finalName;
            });
            
            return skus;
        }

        function copyHelperSKU(btn) {
            const strings = generateCurriculumStrings();
            if(strings.length === 0) {
                showToast('No levels parsed', 'error');
                return;
            }
            
            const textToCopy = strings.join('\n');
            copyHelperAmount(textToCopy, btn); 
        }

        function calculateAutoPricerDuration() {
            const sessions = calculateAutoPricerSessions();
            if(sessions === 0) return 0;
            return Math.round((sessions / 8) * 10) / 10;
        }

        function calculateAutoPricerSessions() {
            if (!apGlobalState.isParsed) return 0;
            
             const allMatches = [...apGlobalState.rawInput.matchAll(/\b([A-Z]+)(\d+)\b/g)];
            const validIndices = [];
            allMatches.forEach(m => { const idx = globalLevelSequence.findIndex(item => item.code === (m[1]+m[2])); if(idx!==-1) validIndices.push(idx); });
            if(validIndices.length===0) return 0;
            
            const firstIdx = validIndices[0]; const lastIdx = validIndices[validIndices.length-1];
            let total = 0;
            
            const isCurrent = apGlobalState.oppMode === 'current';
            const start = isCurrent ? firstIdx : lastIdx + 1;
            
            let limit = 0;
            if(isCurrent) {
                 if(apGlobalState.bundleMode === 'custom') {
                   limit = parseInt(apGlobalState.customCount);
                } else {
                   limit = (lastIdx - firstIdx + 1);
                }
            } else {
                limit = apGlobalState.bundleMode === '3' ? 3 : (apGlobalState.bundleMode === '6' ? 6 : parseInt(apGlobalState.customCount));
            }
            
            for(let i=0; i<limit; i++) {
                const idx = start + i; 
                 if(idx >= globalLevelSequence.length) break;
                const item = globalLevelSequence[idx];
                const isMasters = ['sub_junior', 'junior', 'senior_part_1', 'senior_part_2'].includes(item.levelKey);
                total += isMasters ? 16 : (apGlobalState.classType === 'one_on_one' ? ((item.subIndex - 1) % 3 === 2 ? 8 : 6) : 8);
            }
            return total;
        }

        function calculateAutoPricerPrices() {
            if (!apGlobalState.isParsed) return { fullPrice: 0, finalPrice: 0, discounts: { normal: 0, mgmt: 0, referral: 0 } };
            
            const targetReg = apGlobalState.targetRegion;
            const allMatches = [...apGlobalState.rawInput.matchAll(/\b([A-Z]+)(\d+)\b/g)];
            const validIndices = [];
            allMatches.forEach(m => { const idx = globalLevelSequence.findIndex(item => item.code === (m[1]+m[2])); if(idx!==-1) validIndices.push(idx); });
            if(validIndices.length===0) return { fullPrice: 0, finalPrice: 0, discounts: { normal: 0, mgmt: 0, referral: 0 } };
            
            const firstIdx = validIndices[0]; const lastIdx = validIndices[validIndices.length-1];
            let totalCost = 0;
            
            const isCurrent = apGlobalState.oppMode === 'current';
            const start = isCurrent ? firstIdx : lastIdx + 1;
            
            let limit = 0;
            if(isCurrent) {
                 if(apGlobalState.bundleMode === 'custom') {
                   limit = parseInt(apGlobalState.customCount);
                } else {
                   limit = (lastIdx - firstIdx + 1);
                }
            } else {
                limit = apGlobalState.bundleMode === '3' ? 3 : (apGlobalState.bundleMode === '6' ? 6 : parseInt(apGlobalState.customCount));
            }

             for(let i=0; i<limit; i++) {
                const idx = start + i; 
                if(idx >= globalLevelSequence.length) break;
                const item = globalLevelSequence[idx];
                
                const isMasters = ['sub_junior', 'junior', 'senior_part_1', 'senior_part_2'].includes(item.levelKey);
                let itemPrice = 0;
                
                if (isMasters) {
                    const mData = allPrices[targetReg].masters[apGlobalState.classType][item.levelKey];
                    if (mData) { 
                        const base = Math.floor(mData.price_48 / 3); 
                        const rem = mData.price_48 % 3;
                        const cyclePos = (item.subIndex - 1) % 3;
                        itemPrice = base + (cyclePos === 2 ? rem : 0);
                    }
                } else {
                    let fdGroupKey = targetReg === 'in' ? 'regular_group' : 'group';
                    const fdPrice = allPrices[targetReg].foundation[apGlobalState.classType === 'one_on_one' ? 'one_on_one' : fdGroupKey][item.levelKey];
                    if (fdPrice) {
                        if (apGlobalState.classType === 'one_on_one') {
                            const p1 = Math.round(fdPrice * 0.30), p2 = Math.round(fdPrice * 0.30), p3 = fdPrice - p1 - p2, wIdx = (item.subIndex - 1) % 3;
                            itemPrice = [p1, p2, p3][wIdx];
                        } else {
                            const base = Math.floor(fdPrice / 3), rem = fdPrice % 3, wIdx = (item.subIndex - 1) % 3;
                            itemPrice = base + (wIdx === 2 ? rem : 0);
                        }
                    }
                }
                totalCost += itemPrice;
            }
            
            const refAmt = parseFloat(apGlobalState.referralAmount) || 0;
            
            return {
                fullPrice: totalCost,
                finalPrice: Math.max(0, totalCost - refAmt),
                discounts: { normal: 0, mgmt: 0, referral: refAmt }
            };
        }

        function updateAPState(key, value) {
            apGlobalState[key] = value;
            if (key === 'rawInput' || key === 'targetRegion') {
                const matches = [...apGlobalState.rawInput.matchAll(/\b([A-Z]+)(\d+)\b/g)];
                if (matches.length > 0) {
                    const valid = matches.some(m => globalLevelSequence.findIndex(g => g.code === (m[1]+m[2])) !== -1);
                    if (valid) {
                        apGlobalState.isParsed = true; 
                        apGlobalState.detectedLevelIndex = 0; 
                        
                        const lastMatch = matches[matches.length - 1];
                        const namePart = apGlobalState.rawInput.substring(0, lastMatch.index).trim().split(' ').filter(w => w.length > 2 && !/\d/.test(w));
                        const detectedName = (namePart.filter(n => n !== 'NRNOV24' && n !== 'RENEWAL' && n !== 'NOV25').slice(-2).join(' ')) || "Student";
                        apGlobalState.customerName = detectedName;
                        
                        const rs = getRegionState(currentRegion);
                        if (rs && rs.studentName && rs.studentName.autoPricer) {
                            rs.studentName.autoPricer.name = detectedName;
                        }
                    } else apGlobalState.isParsed = false;
                } else apGlobalState.isParsed = false;
            }
            
            if (key === 'targetRegion') {
                const rs = getRegionState(currentRegion);
                if (rs && rs.studentName && rs.studentName.autoPricer) {
                    rs.studentName.autoPricer.name = apGlobalState.customerName;
                }
                
                apGlobalState.referralAmount = referralDefaults[value] || 20;
            }
            
            if (key === 'customCount') {
                apGlobalState.bundleMode = 'custom';
            }

            const container = document.getElementById(`tab-content-auto-pricer-${currentRegion}`);
            if(container) { 
                container.innerHTML = generateAutoPricerHTML(currentRegion); 
                if(key === 'rawInput') { 
                    const el = document.getElementById('ap-global-input'); 
                    el.focus(); 
                    el.setSelectionRange(el.value.length, el.value.length); 
                } 
            }
        }

        function generateGlobalConverterHTML(region) {
            let opts = ''; Object.entries(conversionCurrencies).forEach(([key, info]) => opts += `<option value="${info.code}">${info.name} (${info.code})</option>`);
            return `<div class="premium-card global-converter-card">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-12 h-12 rounded-full border border-[var(--accent)] flex items-center justify-center text-2xl bg-blue-100 text-blue-700 shadow-md">💱</div>
                    <h2 class="text-2xl font-black text-primary uppercase">Global Currency</h2>
                </div>
                <div class="grid grid-cols-1 gap-5"><div class="flex items-center justify-between"><button type="button" onclick="refreshRates('${region}', 'global')" id="refresh-rates-global-${region}" class="refresh-btn">${icons.refresh} Refresh Rates</button><div class="flex items-center gap-2"><span class="text-[0.65rem] font-bold text-secondary uppercase">Round Off</span><label class="toggle-switch"><input type="checkbox" id="global-round-off-${region}" checked onchange="updateGlobalConverter('${region}')"><span class="toggle-slider"></span></label></div></div><div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">Amount</label><input type="number" id="global-amount-${region}" value="1000" class="input-premium text-xl font-bold" oninput="updateGlobalConverter('${region}')"></div><div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">Base Currency</label><select id="global-base-${region}" class="input-premium" onchange="updateGlobalConverter('${region}')">${opts}</select></div><div class="discount-control"><label class="block text-xs font-bold text-accent mb-2 uppercase">Search Country</label><input type="text" id="global-search-${region}" placeholder="Type country name..." class="input-premium" oninput="updateGlobalConverter('${region}')"></div></div><div id="global-results-${region}" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[400px] overflow-y-auto pr-2"></div></div>`;
        }

        function updateGlobalConverter(region) {
            const amount = parseFloat(document.getElementById(`global-amount-${region}`).value) || 0, base = document.getElementById(`global-base-${region}`).value, search = document.getElementById(`global-search-${region}`).value.toLowerCase(), round = document.getElementById(`global-round-off-${region}`).checked, container = document.getElementById(`global-results-${region}`);
            if(!globalConversionRates) return;
            let html = ''; Object.values(conversionCurrencies).forEach(curr => {
                if(curr.code !== base && (!search || curr.name.toLowerCase().includes(search) || curr.code.toLowerCase().includes(search))) {
                    let val = (amount / globalConversionRates[base]) * globalConversionRates[curr.code];
                    html += `<div class="p-4 rounded-lg border border-[var(--input-border)] bg-[var(--input-bg)] flex items-center justify-between hover:border-[var(--accent)] transition-colors group"><div class="flex items-center gap-3"><span class="text-2xl opacity-80 group-hover:opacity-100 transition">${curr.emoji}</span><div class="flex flex-col"><span class="font-bold text-sm text-primary uppercase tracking-wide">${curr.name}</span><span class="text-[0.65rem] text-secondary font-mono">${curr.code}</span></div></div><span class="font-black text-lg text-accent font-mono">${curr.symbol}${round ? Math.round(val).toLocaleString() : val.toFixed(2)}</span></div>`;
                }
            });
            container.innerHTML = html || '<div class="text-center text-secondary col-span-2 text-sm italic py-4">No countries found.</div>';
        }
        
        function copyHelperAmount(amountStr, btn) {
            const el = document.createElement('textarea');
            el.value = amountStr;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            el.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = `<span class="text-green-600 font-bold">Copied!</span>`;
                    setTimeout(() => { btn.innerHTML = originalHtml; }, 2000);
                } else {
                    showToast('Failed to copy', 'error');
                }
            } catch (err) {
                showToast('Failed to copy', 'error');
            }
            document.body.removeChild(el);
        }

        async function fetchExchangeRates() { try { const response = await fetch('https://api.frankfurter.app/latest?from=USD'); const data = await response.json(); globalConversionRates = { 'USD': 1, 'AED': data.rates.AED || 3.67, 'INR': data.rates.INR || 83.12, 'GBP': data.rates.GBP || 0.79, 'EUR': data.rates.EUR || 0.92, 'SGD': data.rates.SGD || 1.35, 'AUD': data.rates.AUD || 1.52, 'CAD': data.rates.CAD || 1.36, 'QAR': data.rates.QAR || 3.64, 'ZAR': data.rates.ZAR || 18.75, 'SEK': data.rates.SEK || 10.54, 'KWD': 0.31, 'SAR': 3.75, 'BHD': 0.38, 'OMR': 0.385 }; globalConversionTimestamp = Date.now(); return true; } catch (error) { console.error(error); return false; } }
        
        async function refreshRates(region, idPrefix) { const btn = document.getElementById(`refresh-rates-${idPrefix}-${region}`); if(btn) { btn.disabled = true; btn.innerHTML = `${icons.refresh} Refreshing...`; } await fetchExchangeRates(); if(btn) { btn.disabled = false; btn.innerHTML = `${icons.refresh} Refresh`; } if(idPrefix==='global') updateGlobalConverter(region); else ConverterController.triggerUpdate(region, idPrefix); }
        
        function convertPrice(amount, fromCurrencyCode, toCurrencyCode) { if (!globalConversionRates || Object.keys(globalConversionRates).length === 0) return null; const fromRate = globalConversionRates[fromCurrencyCode], toRate = globalConversionRates[toCurrencyCode]; if (!fromRate || !toRate) return null; return (amount / fromRate) * toRate; }

        function showInternalTab(region, tabName) { 
            currentActiveTab = tabName; 
            ['full', 'custom-fd', 'custom-ms', 'global-conv', 'auto-pricer'].forEach(t => { const c = document.getElementById(`tab-content-${t}-${region}`); if(c) c.classList.add('hidden'); const b = document.getElementById(`tab-btn-${t}-${region}`); if(b) b.classList.remove('active'); }); 
            document.getElementById(`tab-content-${tabName}-${region}`).classList.remove('hidden'); document.getElementById(`tab-btn-${tabName}-${region}`).classList.add('active'); 
            
            if(tabName==='full') { populateBenefits(region, 'full'); renderFullOffers(region); ConverterController.triggerUpdate(region, 'full'); } 
            else if(tabName==='custom-fd') { populateBenefits(region, 'foundation'); calculateCustomPackage(region, 'foundation'); ConverterController.triggerUpdate(region, 'foundation'); } 
            else if(tabName==='custom-ms') { populateBenefits(region, 'masters'); calculateCustomPackage(region, 'masters'); ConverterController.triggerUpdate(region, 'masters'); } 
            else if(tabName==='global-conv') { updateGlobalConverter(region); }
            else if(tabName==='auto-pricer') { updateAPState('rawInput', apGlobalState.rawInput); }
        }

        function showCalculator(region) { 
            const previousRegion = currentRegion;
            currentRegion = region; 
            if(document.querySelector('.region-pill.active')) document.querySelector('.region-pill.active').classList.remove('active'); 
            document.getElementById(`nav-${region}`).classList.add('active'); 
            
            const container = document.getElementById('calculator-container');
            document.querySelectorAll('.region-wrapper').forEach(el => el.classList.add('hidden'));
            
            let wrapper = document.getElementById(`wrapper-${region}`);
            if (!wrapper) {
                wrapper = document.createElement('div'); 
                wrapper.id = `wrapper-${region}`; 
                wrapper.className = 'region-wrapper'; 
                wrapper.innerHTML = createCalculatorHTML(region); 
                container.appendChild(wrapper);
                
                const rs = getRegionState(region); 
                rs.full.defaults = [...benefitsData.default]; 
                rs.customFd.defaults = [...benefitsData.default]; 
                rs.customMs.defaults = [...benefitsData.default];
                
                ['full','foundation','masters'].forEach(t => { 
                    const d = document.getElementById(`coupon-type-display-${t}-${region}`); 
                    if(d) d.textContent = rs.customCouponTypes[`${region}-${t}`]||'LOYALTY'; 
                    const l = document.getElementById(`discount-label-display-${t}-${region}`); 
                    if(l) l.textContent = rs.customDiscountLabels[`${region}-${t}`]||'Management Discount'; 
                    PPCController.init(region, t); 
                    ConverterController.updatePreview(region, t);
                });
                
                showInternalTab(region, currentActiveTab);
            }
            wrapper.classList.remove('hidden');

            if (previousRegion && previousRegion !== region && appState[previousRegion]) {
                synchronizeRegionInputs(previousRegion, region);
            }
        }

        function synchronizeRegionInputs(from, to) {
            ['full', 'foundation', 'masters', 'autoPricer'].forEach(t => {
                const name = StudentNameController.getStudentName(from, t);
                const show = StudentNameController.getShowStudentName(from, t);
                StudentNameController.setStudentName(to, t, name);
                StudentNameController.setShowStudentName(to, t, show);
                
                const input = document.getElementById(`student-name-input-${t}-${to}`);
                if(input) input.value = name;
                const toggle = document.getElementById(`student-name-toggle-${t}-${to}`);
                if(toggle) toggle.checked = show;
            });

            const fromClassTypeGlobal = document.querySelector(`input[name="class-type-global-${from}"]:checked`)?.value;
            if(fromClassTypeGlobal) {
                const toRadio = document.querySelector(`input[name="class-type-global-${to}"][value="${fromClassTypeGlobal}"]`);
                if(toRadio) {
                    toRadio.checked = true;
                }
            }
            
            const fromStartLevel = document.getElementById(`upsell-filter-${from}`)?.value;
            if(fromStartLevel && fromStartLevel !== 'none') {
                const toSelect = document.getElementById(`upsell-filter-${to}`);
                if(toSelect) toSelect.value = fromStartLevel;
            }

            ['foundation', 'masters'].forEach(cType => {
                const fromType = document.querySelector(`input[name="class-type-${cType}-${from}"]:checked`)?.value;
                if(fromType) {
                    let targetValue = fromType;
                    if(fromType === 'focused_group' || fromType === 'regular_group') targetValue = 'group';
                    
                    const toRadio = document.querySelector(`input[name="class-type-${cType}-${to}"][value="${targetValue}"]`);
                    if(toRadio) toRadio.checked = true;
                }

                const levels = cType === 'foundation' ? foundationLevels : mastersLevels;
                levels.forEach(lvl => {
                    for(let i=1; i<=6; i++) { 
                         const fromChk = document.getElementById(`chk-${from}-${cType}-${lvl}-sub${i}`);
                         const toChk = document.getElementById(`chk-${to}-${cType}-${lvl}-sub${i}`);
                         if(fromChk && toChk) {
                             toChk.checked = fromChk.checked;
                         }
                    }
                });
            });

            const idPrefixes = ['full', 'foundation', 'masters']; 
            
            idPrefixes.forEach(prefix => {
                const disc = getActiveDiscounts(from, prefix);
                
                const toNormCheck = document.getElementById(`discount-enable-normal-${prefix}-${to}`);
                const toNormInput = document.getElementById(`discount-input-normal-${prefix}-${to}`);
                if(toNormCheck) toNormCheck.checked = document.getElementById(`discount-enable-normal-${prefix}-${from}`)?.checked;
                if(toNormInput) toNormInput.value = disc.normal;

                const toMgmtCheck = document.getElementById(`discount-enable-mgmt-${prefix}-${to}`);
                const toMgmtInput = document.getElementById(`discount-input-mgmt-${prefix}-${to}`);
                if(toMgmtCheck) toMgmtCheck.checked = document.getElementById(`discount-enable-mgmt-${prefix}-${from}`)?.checked;
                if(toMgmtInput) toMgmtInput.value = disc.mgmt;

                const toRefCheck = document.getElementById(`discount-enable-referral-${prefix}-${to}`);
                if(toRefCheck) toRefCheck.checked = document.getElementById(`discount-enable-referral-${prefix}-${from}`)?.checked;
                
                const fromRefBadgeToggle = document.getElementById(`referral-show-toggle-${prefix}-${from}`);
                const toRefBadgeToggle = document.getElementById(`referral-show-toggle-${prefix}-${to}`);
                if(fromRefBadgeToggle && toRefBadgeToggle) toRefBadgeToggle.checked = fromRefBadgeToggle.checked;
                
                const rsFrom = getRegionState(from);
                const rsTo = getRegionState(to);
                rsTo.bannerSettings = { ...rsFrom.bannerSettings };
                
                const banToggle = document.getElementById(`banner-toggle-${prefix}-${to}`);
                if(banToggle) banToggle.checked = rsTo.bannerSettings.showBanner;
                
                if(PPCController.states[`${to}-${prefix}`]) {
                    PPCController.states[`${to}-${prefix}`] = false; 
                    PPCController.renderState(to, prefix);
                }
                
                if(prefix !== 'full') {
                    if(rsFrom.roadmapData) {
                        rsTo.roadmapData = JSON.parse(JSON.stringify(rsFrom.roadmapData));
                        
                        const toShowToggle = document.getElementById(`roadmap-show-toggle-${prefix}-${to}`);
                        if(toShowToggle) toShowToggle.checked = rsFrom.roadmapData[`${prefix}-show`];
                        
                        renderTimelineContainer(to, prefix);
                        
                        const count = rsTo.roadmapData.count || 3;
                        for(let i=1; i<=count; i++) {
                            const lbl = rsTo.roadmapData[`${prefix}-${i}-label`];
                            const lInput = document.getElementById(`roadmap-label-${i}-${prefix}-${to}`);
                            const lDisp = document.getElementById(`roadmap-lbl-display-${i}-${prefix}-${to}`);
                            if(lInput) lInput.value = lbl;
                            if(lDisp) lDisp.textContent = lbl;
                            
                            const dateVal = document.getElementById(`roadmap-date-${i}-${prefix}-${from}`)?.value;
                            const percVal = document.getElementById(`roadmap-percent-${i}-${prefix}-${from}`)?.value;
                            
                            const toDate = document.getElementById(`roadmap-date-${i}-${prefix}-${to}`);
                            const toPerc = document.getElementById(`roadmap-percent-${i}-${prefix}-${to}`);
                            if(toDate) toDate.value = dateVal;
                            if(toPerc) toPerc.value = percVal;
                        }
                        
                        const cont = document.getElementById(`roadmap-container-${prefix}-${to}`);
                        if(cont) {
                            if(rsTo.roadmapData[`${prefix}-show`]) cont.classList.remove('hidden');
                            else cont.classList.add('hidden');
                        }
                    }
                }
            });
            
            if(currentActiveTab === 'full') recalcFullOffers(to);
            else if(currentActiveTab === 'custom-fd') calculateCustomPackage(to, 'foundation');
            else if(currentActiveTab === 'custom-ms') calculateCustomPackage(to, 'masters');
        }
        
        function togglePPCVisibility(region, idPrefix) { const rs = getRegionState(region); rs.showPPCInOutput[`${region}-${idPrefix}`] = !rs.showPPCInOutput[`${region}-${idPrefix}`]; idPrefix === 'full' ? recalcFullOffers(region) : calculateCustomPackage(region, idPrefix); }
        function showCouponTypeDropdown(region, idPrefix) { toggleDropdownState(`coupon-type-dropdown-${idPrefix}-${region}`); }
        function selectCouponType(region, idPrefix, type) { const val = type === 'CUSTOM' ? (prompt('Enter custom coupon type:') || '').trim().toUpperCase() : type; if (!val && type === 'CUSTOM') return; getRegionState(region).customCouponTypes[`${region}-${idPrefix}`] = val; document.getElementById(`coupon-type-display-${idPrefix}-${region}`).textContent = val; toggleDropdownState(`coupon-type-dropdown-${idPrefix}-${region}`); idPrefix === 'full' ? recalcFullOffers(region) : calculateCustomPackage(region, idPrefix); }
        function showDiscountLabelDropdown(region, idPrefix) { toggleDropdownState(`discount-label-dropdown-${idPrefix}-${region}`); }
        function selectDiscountLabel(region, idPrefix, label) { const val = label === 'CUSTOM' ? (prompt('Enter custom discount label:') || '').trim() : label; if (!val && label === 'CUSTOM') return; getRegionState(region).customDiscountLabels[`${region}-${idPrefix}`] = val; document.getElementById(`discount-label-display-${idPrefix}-${region}`).textContent = val; toggleDropdownState(`discount-label-dropdown-${idPrefix}-${region}`); idPrefix === 'full' ? recalcFullOffers(region) : calculateCustomPackage(region, idPrefix); }
        
        function generateBenefitsHTML(b) { return b.length===0 ? '<ul class="benefits-list-card"><li class="text-secondary italic">None selected.</li></ul>' : '<ul class="benefits-list-card">' + b.map(t => `<li>${icons.checkCircle}<span>${t}</span></li>`).join('') + '</ul>'; }
        function getRelevantBenefits(r, crs, cls) { let b = [...benefitsData.all, ...benefitsData.default]; if(cls.includes('group')) b.push(...benefitsData.group); else b.push(...benefitsData.one_on_one); if(crs==='masters') { b.push(...benefitsData.masters); if(cls==='one_on_one') b.push(...benefitsData.masters_one_on_one_exclusive); } return [...new Set(b)]; }
        function populateBenefits(region, idPrefix) { 
            const rs = getRegionState(region), sKey = idPrefix==='full'?'full':(idPrefix==='foundation'?'customFd':'customMs'), list = document.getElementById(`available-benefits-list-${idPrefix}-${region}`); if(!list) return; 
            let crs, cls; 
            if(idPrefix==='full') { 
                crs='masters'; 
                const radio = document.querySelector(`input[name="class-type-global-${region}"]:checked`); 
                cls = radio ? radio.value : 'one_on_one'; 
            } else { 
                crs=idPrefix; 
                cls=document.querySelector(`input[name="class-type-${crs}-${region}"]:checked`)?.value||'one_on_one'; 
            } 
            
            if(rs[sKey].selected.length === 0) rs[sKey].selected = [...rs[sKey].defaults]; 
            
            list.innerHTML=''; 
            
            getRelevantBenefits(region, crs, cls).forEach(t => { 
                const isDef = rs[sKey].defaults.includes(t); 
                const item = document.createElement('div'); 
                item.className='benefit-item'; 
                item.innerHTML=`<span class="benefit-item-text">${t}</span><button type="button" class="benefit-btn star ${isDef?'active':''}" onclick="toggleDefaultBenefit('${region}','${idPrefix}', \`${t.replace(/`/g, '\\`')}\`)">${icons.star}</button><button type="button" class="benefit-btn benefit-btn-add" onclick="addBenefit('${region}','${idPrefix}', \`${t.replace(/`/g, '\\`')}\`)">${icons.plus}</button>`; 
                list.appendChild(item); 
            }); 
            renderSelectedBenefits(region, idPrefix); 
        }

        function addBenefit(r, p, t) { const k = p==='full'?'full':(p==='foundation'?'customFd':'customMs'), rs = getRegionState(r); if(!rs[k].selected.includes(t)){ rs[k].selected.push(t); renderSelectedBenefits(r, p); } }
        function addCustomBenefit(r, p) { const i = document.getElementById(`custom-benefit-input-${p}-${r}`); if(i.value.trim()){ addBenefit(r, p, i.value.trim()); i.value=''; } }
        function removeBenefit(r, p, idx) { const k = p==='full'?'full':(p==='foundation'?'customFd':'customMs'); getRegionState(r)[k].selected.splice(idx, 1); renderSelectedBenefits(r, p); }
        function toggleDefaultBenefit(r, p, t) { const k = p==='full'?'full':(p==='foundation'?'customFd':'customMs'), rs = getRegionState(r), idx = rs[k].defaults.indexOf(t), btn = event.target.closest('.star'); if(idx>-1) { rs[k].defaults.splice(idx,1); btn.classList.remove('active'); const sIdx = rs[k].selected.indexOf(t); if(sIdx>-1) removeBenefit(r, p, sIdx); } else { rs[k].defaults.push(t); btn.classList.add('active'); addBenefit(r, p, t); } }
        
        function renderSelectedBenefits(r, p) { 
            const k = p==='full'?'full':(p==='foundation'?'customFd':'customMs');
            const l = document.getElementById(`selected-benefits-list-${p}-${r}`); 
            if(!l) return; 
            
            const rs = getRegionState(r); 
            l.innerHTML = rs[k].selected.length===0 ? '<li class="benefit-item text-secondary italic">None.</li>' : ''; 
            
            rs[k].selected.forEach((t, i) => { 
                const item = document.createElement('div'); 
                item.className='benefit-item'; 
                item.innerHTML=`<span class="benefit-item-text">${t}</span><button type="button" class="benefit-btn benefit-btn-remove" onclick="removeBenefit('${r}', '${p}', ${i})">${icons.minus}</button>`; 
                l.appendChild(item); 
            }); 
            
            p==='full' ? recalcFullOffers(r) : calculateCustomPackage(r, p); 
        }
        
    window.addEventListener('DOMContentLoaded', async () => { 
        const regs = Object.keys(regionNames); 
        document.getElementById('region-nav').innerHTML = regs.map(r => `<button id="nav-${r}" onclick="showCalculator('${r}')" class="region-pill">${regionNames[r]}</button>`).join(''); 
        await fetchExchangeRates(); 
        showCalculator(regs[0]); 
        console.log("V108.44: Grandmaster Edition Loaded (Price Fix - USA/WW Separated)"); 
    });
    </script>
</body>
</html>